# Deployment Guide

This document provides instructions for deploying Solo Guardian to production.

## Quick Links

- üê≥ **[Docker Deployment Guide](./DOCKER.md)** - Recommended for VPS and cloud deployments
- üì± **Frontend (Vercel)** - See below
- üñ•Ô∏è **Backend** - Railway, Render, or Docker

## Architecture Overview

Solo Guardian is a monorepo with separate frontend and backend applications:

- **Frontend (apps/user-web)**: React + Vite SPA - Deploy to **Vercel**
- **Backend (apps/backend)**: NestJS API with PostgreSQL + Redis - Deploy to **Railway/Render/Docker**

## Deployment Options Summary

| Component | Platform | Guide |
|-----------|----------|-------|
| **Backend** | Docker (VPS/Cloud) | [DOCKER.md](./DOCKER.md) ‚≠ê Recommended |
| Backend | Railway | See "Railway Deployment" below |
| Backend | Render | See "Render Deployment" below |
| Backend | Custom VPS | [DOCKER.md](./DOCKER.md) |
| **Frontend** | Vercel | See "Frontend Deployment" below |

## Frontend Deployment (Vercel)

### Prerequisites

- GitHub repository connected to Vercel
- Vercel CLI installed (optional): `pnpm add -g vercel`

### Automated Deployment via Vercel Dashboard

1. **Import Project**
   - Go to [Vercel Dashboard](https://vercel.com/new)
   - Import your GitHub repository
   - Vercel will auto-detect the monorepo structure

2. **Configure Build Settings**

   The project includes a `vercel.json` configuration that automatically sets:
   - **Build Command**: `cd apps/user-web && pnpm run build`
   - **Output Directory**: `apps/user-web/dist`
   - **Install Command**: `pnpm install`

3. **Set Environment Variables**

   In Vercel Dashboard ‚Üí Settings ‚Üí Environment Variables, add:

   ```
   VITE_API_URL=https://your-backend-api.com
   ```

   **Important**: Replace `https://your-backend-api.com` with your actual backend URL (see Backend Deployment section below)

4. **Deploy**
   - Click "Deploy"
   - Vercel will build and deploy your frontend
   - You'll get a production URL like `https://your-app.vercel.app`

### Manual Deployment via Vercel CLI

```bash
# Install Vercel CLI
pnpm add -g vercel

# Login to Vercel
vercel login

# Deploy (from project root)
vercel

# Deploy to production
vercel --prod
```

### Environment Variables

| Variable | Description | Example | Required |
|----------|-------------|---------|----------|
| `VITE_API_URL` | Backend API base URL | `https://api.your-domain.com` | Yes |

## Backend Deployment

The backend requires:
- PostgreSQL database
- Redis instance
- Node.js runtime environment
- Environment variables for SMTP, Twilio, JWT secrets

### Recommended Platforms

#### Option 1: Railway (Recommended)

Railway provides managed PostgreSQL + Redis and easy NestJS deployment.

1. **Create New Project** on [Railway](https://railway.app)
2. **Add PostgreSQL Database**
   - Click "+ New" ‚Üí Database ‚Üí PostgreSQL
   - Railway auto-generates `DATABASE_URL`
3. **Add Redis**
   - Click "+ New" ‚Üí Database ‚Üí Redis
   - Railway auto-generates `REDIS_URL` (e.g., `redis://default:password@hostname:port`)
   - If Railway only provides separate variables, construct `REDIS_URL` as: `redis://<REDIS_HOST>:<REDIS_PORT>`
4. **Deploy Backend**
   - Click "+ New" ‚Üí GitHub Repo
   - Select your repository
   - Set root directory to `apps/backend`
   - Railway auto-detects NestJS
5. **Set Environment Variables**

   Add all variables from `apps/backend/.env.example`:

   ```
   DATABASE_URL=<auto-generated-by-railway>
   REDIS_URL=<auto-generated-by-railway>

   JWT_ACCESS_SECRET=<generate-random-32-char-string>
   JWT_REFRESH_SECRET=<generate-random-32-char-string>

   SMTP_HOST=smtp.gmail.com
   SMTP_PORT=587
   SMTP_USER=your-email@gmail.com
   SMTP_PASS=your-app-password

   TWILIO_ACCOUNT_SID=<your-twilio-sid>
   TWILIO_AUTH_TOKEN=<your-twilio-token>
   TWILIO_PHONE_NUMBER=<your-twilio-number>

   # OAuth (Optional - Not fully implemented yet)
   GOOGLE_OAUTH_ENABLED=false
   GOOGLE_OAUTH_CLIENT_ID=<your-google-oauth-client-id>
   GOOGLE_OAUTH_CLIENT_SECRET=<your-google-oauth-secret>
   GOOGLE_OAUTH_CALLBACK_URL=https://your-backend-url/api/auth/oauth/google/callback

   APPLE_OAUTH_ENABLED=false
   APPLE_OAUTH_CLIENT_ID=<your-apple-service-id>
   APPLE_OAUTH_TEAM_ID=<your-apple-team-id>
   APPLE_OAUTH_KEY_ID=<your-apple-key-id>
   APPLE_OAUTH_PRIVATE_KEY=<your-apple-private-key>
   APPLE_OAUTH_CALLBACK_URL=https://your-backend-url/api/auth/oauth/apple/callback
   ```

   **Note**: OAuth providers (Google/Apple) are not fully implemented yet. You can leave them disabled (`ENABLED=false`) for initial deployment.

6. **Deploy**
   - Railway auto-deploys on git push
   - Get your backend URL from Railway dashboard
   - **Update Vercel `VITE_API_URL`** with this URL

#### Option 2: Render

Similar to Railway, follow [Render's NestJS deployment guide](https://render.com/docs/deploy-nestjs).

#### Option 3: VPS (DigitalOcean, AWS EC2, etc.)

For full control, deploy to a VPS:

```bash
# On your VPS
git clone <your-repo>
cd solo-guardian

# Install dependencies
pnpm install

# Setup PostgreSQL and Redis
# Configure environment variables in apps/backend/.env

# Build and run
cd apps/backend
pnpm run build
pnpm run prisma:migrate  # Run database migrations
pnpm run start:prod
```

Use PM2 or systemd to keep the process running.

## Post-Deployment Checklist

- [ ] Frontend deployed to Vercel
- [ ] Backend deployed to Railway/Render/VPS
- [ ] PostgreSQL database running and migrations applied
- [ ] Redis instance running
- [ ] All environment variables configured
- [ ] `VITE_API_URL` in Vercel points to backend URL
- [ ] CORS configured in backend to allow frontend domain
- [ ] SMTP/Twilio configured and tested
- [ ] Database backups enabled
- [ ] (Optional) OAuth callback URLs updated in Google/Apple consoles if enabled

## Continuous Deployment

Both Vercel and Railway support automatic deployments:

- **Push to `main`** ‚Üí Auto-deploy to production
- **Push to other branches** ‚Üí Create preview deployments

Configure branch protection and require PR reviews before merging to `main`.

## Monitoring

### Vercel Analytics

Enable [Vercel Analytics](https://vercel.com/analytics) for frontend monitoring.

### Backend Monitoring

Consider adding:
- **Sentry** for error tracking
- **LogRocket** for session replay
- **Prometheus + Grafana** for metrics

## Troubleshooting

### Build Fails on Vercel

**Issue**: `Cannot find module '@solo-guardian/api-client'`

**Solution**: Vercel uses pnpm workspaces. Ensure `vercel.json` has:
```json
{
  "installCommand": "pnpm install"
}
```

### Frontend Can't Connect to Backend

**Issue**: CORS errors or network failures

**Solutions**:
1. Verify `VITE_API_URL` in Vercel matches your backend URL
2. Enable CORS in backend for your Vercel domain
3. Check backend is running and accessible

### Database Connection Issues

**Issue**: `Can't reach database server`

**Solution**:
1. Verify `DATABASE_URL` is correct
2. Check database allows connections from backend IP
3. Run migrations from backend directory: `cd apps/backend && pnpm run prisma:migrate`

## Scaling Considerations

As your app grows:

1. **Database**: Upgrade to managed PostgreSQL with replicas
2. **Redis**: Use managed Redis (Upstash, Redis Cloud)
3. **CDN**: Vercel includes CDN for frontend
4. **Backend**: Scale horizontally with load balancer
5. **Queue Workers**: Separate Bull workers into dedicated instances

## Security Checklist

- [ ] Use strong JWT secrets (min 32 characters)
- [ ] Enable HTTPS only (Vercel/Railway handle this)
- [ ] Rotate secrets regularly
- [ ] Enable rate limiting on backend
- [ ] Use environment variables for all secrets (never commit)
- [ ] Enable database encryption at rest
- [ ] Set up WAF (Web Application Firewall) if needed
- [ ] Regular security audits with `pnpm audit`

## Support

For deployment issues, check:
- [Vercel Documentation](https://vercel.com/docs)
- [Railway Documentation](https://docs.railway.app)
- [NestJS Deployment](https://docs.nestjs.com/deployment)
