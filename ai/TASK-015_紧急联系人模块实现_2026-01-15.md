# TASK-015: 紧急联系人模块实现

## 任务概述

完成紧急联系人模块的 TODO(B) 标记，验证所有功能实现。

## 变更内容

### 修改文件
| 文件 | 变更类型 | 描述 |
|------|----------|------|
| `emergency-contacts.controller.ts` | 修改 | 更新 TODO(B) 为 DONE(B) |
| `emergency-contacts.service.ts` | 修改 | 更新 TODO(B) 为 DONE(B) |
| `emergency-contacts.repository.ts` | 修改 | 更新 TODO(B) 为 DONE(B) |
| `.claude/handoffs/iter-006/IR-015-emergency-contacts-module.yaml` | 新增 | 实现报告 |

## 已实现功能

### API 端点

| 方法 | 路径 | 描述 |
|------|------|------|
| GET | `/api/v1/emergency-contacts` | 获取所有联系人 |
| GET | `/api/v1/emergency-contacts/:id` | 获取单个联系人 |
| POST | `/api/v1/emergency-contacts` | 创建联系人 |
| PUT | `/api/v1/emergency-contacts/:id` | 更新联系人 |
| DELETE | `/api/v1/emergency-contacts/:id` | 软删除联系人 |
| PUT | `/api/v1/emergency-contacts/reorder` | 重新排序联系人 |

### Service 层方法

| 方法 | 描述 |
|------|------|
| `findAll` | 获取用户所有活跃联系人，映射为 DTO |
| `findOne` | 按 ID 获取联系人，验证所有权 |
| `create` | 创建联系人，检查数量限制(5)和邮箱唯一性 |
| `update` | 更新联系人，验证所有权和邮箱唯一性 |
| `remove` | 软删除联系人 (设置 deletedAt) |
| `reorder` | 根据数组位置更新优先级 |
| `mapToResponse` | 实体映射为 DTO (排除 deletedAt) |

### Repository 层方法

| 方法 | 描述 |
|------|------|
| `findAllByUserId` | 查找所有未删除联系人，按优先级排序 |
| `findById` | 按 ID 查找联系人 |
| `findByEmail` | 按 userId 和 email 查找联系人 |
| `countByUserId` | 统计用户活跃联系人数量 |
| `create` | 创建新联系人记录 |
| `update` | 更新联系人字段 |
| `softDelete` | 设置 deletedAt 时间戳 |
| `updatePriorities` | 事务中批量更新优先级 |

## 业务规则

- 每用户最多 5 个联系人
- 每用户邮箱唯一
- 软删除（不物理删除）
- 支持优先级排序

## 验证结果

| 检查项 | 状态 |
|--------|------|
| TypeScript 编译 | 通过 |
| TODO(B) 标记检查 | 通过 (无残留) |

## Git 提交

```
feat(backend): complete emergency contacts module implementation

Task: TASK-015
Design State: v1.4.1
```

## 约束合规性

| 约束 | 状态 |
|------|------|
| Controller 只验证和调用 Service | ✅ 合规 |
| Service 有业务逻辑，不直接访问数据库 | ✅ 合规 |
| Repository 处理数据库操作 | ✅ 合规 |
| 敏感操作已记录日志 | ✅ 合规 |
| 无 any 类型 | ✅ 合规 |
| 单函数 < 50 行 | ✅ 合规 |
