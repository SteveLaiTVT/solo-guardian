# iter-007 设计: 用户偏好与错误处理基础设施

## 设计摘要

**日期**: 2026-01-15
**版本**: 1.6.0
**分支**: feature/iter-007-preferences-errors
**里程碑**: User Preferences & Error Handling

## 迭代目标

建立用户偏好系统和标准化错误处理基础设施，为适老化设计和无障碍功能奠定基础。

## 核心设计决策

### ADR-011: 功能开关系统

**决策**: 使用 `preferFeaturesOn` 标志的功能开关系统

**要点**:
- 不给用户贴标签（不使用"老年"/"年轻"模式）
- 用户自行选择需要的功能
- `preferFeaturesOn`: 软件升级时是否自动启用新功能
- 核心功能作为数据库列（可查询）
- 可选功能存储在 JSON 字段（灵活，无需迁移）

### ADR-012: 标准化错误处理

**决策**: 带 i18n 支持的标准化错误处理

**要点**:
- 错误码在后端和前端之间共享 (packages/types)
- 错误分类: VALIDATION, AUTH, BUSINESS, NOT_FOUND, CONFLICT, RATE_LIMIT, SYSTEM
- 后端: BusinessException + GlobalExceptionFilter
- 前端: useErrorHandler hook + i18n 错误消息
- 用户错误显示友好提示，系统错误显示道歉信息

## 任务列表

| 任务 ID | 标题 | 优先级 | 依赖 |
|---------|------|--------|------|
| TASK-017 | 共享: 错误码和类型 | P0 | - |
| TASK-018 | 后端: 错误处理基础设施 | P0 | TASK-017 |
| TASK-019 | 前端: 错误处理钩子和 i18n | P0 | TASK-017 |
| TASK-020 | 数据库: UserPreferences 模型 | P0 | - |
| TASK-021 | 后端: 用户偏好模块 | P0 | TASK-020, TASK-018 |
| TASK-022 | 前端: 偏好设置和引导流程 | P0 | TASK-021, TASK-019 |

## 任务依赖图

```
TASK-017 (错误码) ──┬──> TASK-018 (后端错误) ──┐
                   │                          │
                   └──> TASK-019 (前端错误) ──┼──> TASK-022 (前端偏好)
                                              │
TASK-020 (偏好DB) ──> TASK-021 (后端偏好) ────┘
```

## 数据库模型: UserPreferences

```prisma
model UserPreferences {
  id                   String   @id @default(uuid())
  userId               String   @unique

  // 新功能行为
  preferFeaturesOn     Boolean  @default(false)

  // 视觉偏好
  fontSize             Int      @default(16)  // 14-24
  highContrast         Boolean  @default(false)
  reducedMotion        Boolean  @default(false)
  warmColors           Boolean  @default(false)

  // 核心功能开关
  hobbyCheckIn         Boolean  @default(false)
  familyAccess         Boolean  @default(false)

  // 可选功能 (JSON)
  optionalFeatures     Json     @default("{}")

  // 引导
  onboardingCompleted  Boolean  @default(false)

  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
}
```

## 错误响应格式

```json
{
  "success": false,
  "error": {
    "code": "CONTACT_4002",
    "category": "BUSINESS",
    "message": "Contact limit reached",
    "i18nKey": "error.contact.limitReached",
    "details": { "currentCount": 5, "maxAllowed": 5 },
    "timestamp": "2026-01-15T10:00:00Z"
  }
}
```

## 引导流程

```
步骤 1: 欢迎
步骤 2: preferFeaturesOn 选择 (自动启用新功能 / 保持简单)
步骤 3: 功能选择 (爱好签到, 家庭访问)
步骤 4: 视觉设置 (字体大小, 高对比度, 减少动画, 暖色调)
```

## 创建的文件

### Handoff 文件
- `.claude/handoffs/iter-007/HO-017-error-codes.yaml`
- `.claude/handoffs/iter-007/HO-018-backend-errors.yaml`
- `.claude/handoffs/iter-007/HO-019-frontend-errors.yaml`
- `.claude/handoffs/iter-007/HO-020-preferences-db.yaml`
- `.claude/handoffs/iter-007/HO-021-preferences-backend.yaml`
- `.claude/handoffs/iter-007/HO-022-preferences-frontend.yaml`

## 下一步

1. B Session 开始实现 TASK-017 (共享错误码)
2. 并行实现 TASK-020 (数据库模型)
3. 完成后由 C Session 审查

## 公益软件理念

> "无论年龄大小，每个人都值得被爱和关怀。"

本迭代的设计原则:
- 简单胜于复杂
- 清晰胜于花哨
- 温暖胜于冰冷
- 尊重用户选择
