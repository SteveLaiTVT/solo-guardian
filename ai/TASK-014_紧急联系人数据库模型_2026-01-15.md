# TASK-014: 紧急联系人数据库模型

## 任务概述

为 Solo Guardian 添加紧急联系人数据库模型，用于存储用户的紧急联系人信息。

## 变更内容

### 修改文件
| 文件 | 变更类型 | 描述 |
|------|----------|------|
| `apps/backend/prisma/schema.prisma` | 修改 | 添加 EmergencyContact 模型和 User 关联 |
| `apps/backend/prisma/migrations/20260115114421_add_emergency_contacts/migration.sql` | 新增 | Prisma 生成的迁移文件 |
| `.claude/handoffs/iter-006/IR-014-emergency-contact-db.yaml` | 新增 | 实现报告 |

### EmergencyContact 模型字段

| 字段 | 类型 | 描述 |
|------|------|------|
| `id` | UUID | 主键 |
| `userId` | String | 用户外键 |
| `name` | String | 联系人姓名 |
| `email` | String | 联系人邮箱 |
| `phone` | String? | 联系人电话（可选） |
| `priority` | Int | 通知顺序 (1-5)，默认 1 |
| `isVerified` | Boolean | 邮箱验证状态，默认 false |
| `isActive` | Boolean | 是否启用，默认 true |
| `createdAt` | DateTime | 创建时间 |
| `updatedAt` | DateTime | 更新时间 |
| `deletedAt` | DateTime? | 软删除时间戳 |

### 约束和索引

| 类型 | 字段 | 用途 |
|------|------|------|
| 唯一约束 | (userId, email) | 防止同一用户添加重复联系人 |
| 唯一约束 | (userId, priority) | 确保通知顺序唯一 |
| 索引 | (userId, isActive) | 高效查询活跃联系人 |
| 外键 | userId → users.id | 级联删除 |

## 迁移信息

- **迁移名称**: `add_emergency_contacts`
- **时间戳**: `20260115114421`
- **状态**: 已应用

### 生成的 SQL

```sql
CREATE TABLE "emergency_contacts" (
    "id" TEXT NOT NULL,
    "user_id" TEXT NOT NULL,
    "name" TEXT NOT NULL,
    "email" TEXT NOT NULL,
    "phone" TEXT,
    "priority" INTEGER NOT NULL DEFAULT 1,
    "is_verified" BOOLEAN NOT NULL DEFAULT false,
    "is_active" BOOLEAN NOT NULL DEFAULT true,
    "created_at" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
    "updated_at" TIMESTAMP(3) NOT NULL,
    "deleted_at" TIMESTAMP(3),
    CONSTRAINT "emergency_contacts_pkey" PRIMARY KEY ("id")
);

CREATE INDEX "emergency_contacts_user_id_is_active_idx" ON "emergency_contacts"("user_id", "is_active");
CREATE UNIQUE INDEX "emergency_contacts_user_id_email_key" ON "emergency_contacts"("user_id", "email");
CREATE UNIQUE INDEX "emergency_contacts_user_id_priority_key" ON "emergency_contacts"("user_id", "priority");
ALTER TABLE "emergency_contacts" ADD CONSTRAINT "emergency_contacts_user_id_fkey"
    FOREIGN KEY ("user_id") REFERENCES "users"("id") ON DELETE CASCADE ON UPDATE CASCADE;
```

## Git 提交

```
feat(backend): add EmergencyContact database model

Task: TASK-014
Design State: v1.4.0
```

## 验收标准检查

| 标准 | 状态 |
|------|------|
| EmergencyContact 表存在于数据库 | ✅ 通过 |
| (userId, email) 唯一约束防止重复联系人 | ✅ 通过 |
| (userId, priority) 唯一约束确保顺序唯一 | ✅ 通过 |
| (userId, isActive) 索引用于高效查询 | ✅ 通过 |
| 迁移文件已生成并应用 | ✅ 通过 |

## 后续任务

- TASK-015: 紧急联系人模块实现 (Service, Controller, DTOs)
