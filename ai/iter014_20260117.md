# iter-014: 邮件模板、预警系统、事件追踪、家庭与照护者功能

## 变更日期: 2026-01-17

## 变更概要

### Phase A: 模板与分析系统

#### 数据库模型 (schema.prisma)
- 新增 `EmailTemplate` 模型 - 多语言邮件模板存储，支持代码变量和主题
- 新增 `SmsTemplate` 模型 - 多语言短信模板存储
- 扩展 `CaregiverRelation` - 添加 `relationshipType` 字段 (caregiver/family/caretaker)
- 扩展 `CheckIn` - 添加 `checkedInByCaretakerId` 字段，追踪代签到
- 新增 `CaregiverNote` 模型 - 照护者每日观察记录
- 新增 `CaregiverInvitation` 模型 - QR码/邮件/电话邀请令牌

#### 模板模块 (apps/backend/src/modules/templates/)
- `templates.repository.ts` - 模板数据库操作
- `templates.service.ts` - 模板CRUD和渲染服务
- `templates.controller.ts` - 管理员API端点
- DTOs: `CreateEmailTemplateDto`, `UpdateEmailTemplateDto`, `CreateSmsTemplateDto`, `UpdateSmsTemplateDto`

#### 邮件服务改进 (apps/backend/src/modules/email/)
- 修改 `email.service.ts` - 使用数据库模板（带回退到文件模板）
- 添加语言参数支持

#### 分析模块 (apps/backend/src/modules/analytics/)
- `analytics.interface.ts` - 事件追踪接口定义
- `console-analytics.provider.ts` - 控制台日志分析提供者
- `analytics.service.ts` - 分析服务门面
- 追踪事件类型: login, logout, register, check-in, settings, contacts, alerts, caregiver

#### 服务集成
- `auth.service.ts` - 添加登录、注册追踪
- `check-in.service.ts` - 添加签到、设置更新追踪

### Phase B: 预警系统

#### 管理模块扩展 (apps/backend/src/modules/admin/)
- `admin.repository.ts` - 添加 `getAtRiskUsers()` 方法
- `admin.service.ts` - 添加 `getAtRiskUsers()` 服务方法
- `admin.controller.ts` - 添加 `GET /admin/early-warning/at-risk-users` 端点
- 新增 `AtRiskUserDto` 响应类型

### Phase C: 家庭与照护者功能

#### 照护者模块扩展 (apps/backend/src/modules/caregiver/)
- `caregiver.repository.ts` - 添加邀请、备注、代签到方法
- `caregiver.service.ts` - 添加业务逻辑方法
- `caregiver.controller.ts` - 添加新API端点

新增API端点:
- `POST /caregiver/invitations` - 创建邀请（返回QR令牌）
- `GET /caregiver/invitations/:token` - 获取邀请详情（公开）
- `POST /caregiver/invitations/:token/accept` - 接受邀请
- `POST /caregiver/elders/:id/check-in` - 代为签到（仅照护者）
- `POST /caregiver/elders/:id/notes` - 添加观察备注
- `GET /caregiver/elders/:id/notes` - 获取备注历史

#### 国际化 (apps/user-web/src/i18n/)
- 新增 `locales/en/caregiver.json` - 英文翻译
- 新增 `locales/zh/caregiver.json` - 中文翻译
- 新增 `locales/ja/caregiver.json` - 日文翻译
- 更新 `index.ts` - 注册caregiver命名空间
- 更新 `locales/*/common.json` - 添加照护导航标签

#### API客户端 (packages/api-client/)
- `types.ts` - 新增照护者相关类型（ElderSummary, CaregiverSummary, InvitationResponse等）
- `api.ts` - 新增照护者API方法（getElders, createInvitation, checkInOnBehalf等）
- `hooks.ts` - 新增照护者React Query hooks

#### 前端UI (apps/user-web/)
- `src/components/caregiver/CreateInvitationDialog.tsx` - QR码邀请对话框
- `src/pages/accept-invitation/AcceptInvitationPage.tsx` - 接受邀请页面
- `src/pages/caregiver/CaregiverPage.tsx` - 照护者仪表板
- `src/pages/caregiver/ElderDetailSheet.tsx` - 长者详情侧边栏（代签到、备注）
- `src/components/layout/MobileNav.tsx` - 添加照护导航
- `src/App.tsx` - 添加新路由

### 数据库迁移
- `20260117070201_iter014_templates_invitations_notes` - 已应用

## 已完成 ✓

所有Phase A、B、C任务已完成，包括：
- 邮件/短信模板系统
- 预警系统
- 事件追踪
- 家庭与照护者功能（后端+前端）

## 新增API端点汇总

### 模板管理 (Admin)
```
GET/POST   /api/v1/admin/templates/email
GET/PUT/DELETE /api/v1/admin/templates/email/:id
GET/POST   /api/v1/admin/templates/sms
GET/PUT/DELETE /api/v1/admin/templates/sms/:id
```

### 预警系统 (Admin)
```
GET /api/v1/admin/early-warning/at-risk-users
```

### 照护者/家庭
```
POST /api/v1/caregiver/invitations
GET  /api/v1/caregiver/invitations/:token
POST /api/v1/caregiver/invitations/:token/accept
POST /api/v1/caregiver/elders/:id/check-in
POST /api/v1/caregiver/elders/:id/notes
GET  /api/v1/caregiver/elders/:id/notes
```

## 文件变更列表

### 新增文件
- `apps/backend/src/modules/templates/*` (6个文件)
- `apps/backend/src/modules/analytics/*` (5个文件)
- `apps/backend/src/modules/admin/dto/at-risk-users.dto.ts`
- `apps/backend/src/modules/caregiver/dto/invitation.dto.ts`
- `apps/backend/src/modules/caregiver/dto/caregiver-note.dto.ts`
- `apps/user-web/src/i18n/locales/*/caregiver.json` (3个文件)
- `apps/backend/prisma/migrations/20260117070201_iter014_templates_invitations_notes/migration.sql`
- `apps/user-web/src/components/caregiver/CreateInvitationDialog.tsx`
- `apps/user-web/src/pages/accept-invitation/AcceptInvitationPage.tsx`
- `apps/user-web/src/pages/accept-invitation/index.ts`
- `apps/user-web/src/pages/caregiver/CaregiverPage.tsx`
- `apps/user-web/src/pages/caregiver/ElderDetailSheet.tsx`
- `apps/user-web/src/pages/caregiver/index.ts`
- `apps/user-web/src/components/ui/sheet.tsx`
- `apps/user-web/src/components/ui/tabs.tsx`
- `apps/user-web/src/components/ui/textarea.tsx`
- `apps/user-web/src/components/ui/separator.tsx`
- `apps/user-web/src/components/ui/badge.tsx`

### 修改文件
- `apps/backend/prisma/schema.prisma`
- `apps/backend/src/app.module.ts`
- `apps/backend/src/modules/email/email.module.ts`
- `apps/backend/src/modules/email/email.service.ts`
- `apps/backend/src/modules/admin/admin.repository.ts`
- `apps/backend/src/modules/admin/admin.service.ts`
- `apps/backend/src/modules/admin/admin.controller.ts`
- `apps/backend/src/modules/admin/dto/index.ts`
- `apps/backend/src/modules/caregiver/caregiver.repository.ts`
- `apps/backend/src/modules/caregiver/caregiver.service.ts`
- `apps/backend/src/modules/caregiver/caregiver.controller.ts`
- `apps/backend/src/modules/caregiver/dto/index.ts`
- `apps/backend/src/modules/auth/auth.service.ts`
- `apps/backend/src/modules/check-in/check-in.service.ts`
- `apps/user-web/src/i18n/index.ts`
- `packages/api-client/src/types.ts`
- `packages/api-client/src/api.ts`
- `packages/api-client/src/hooks.ts`
- `apps/user-web/src/App.tsx`
- `apps/user-web/src/components/caregiver/index.ts`
- `apps/user-web/src/components/layout/MobileNav.tsx`
- `apps/user-web/src/i18n/locales/en/common.json`
- `apps/user-web/src/i18n/locales/zh/common.json`
- `apps/user-web/src/i18n/locales/ja/common.json`
