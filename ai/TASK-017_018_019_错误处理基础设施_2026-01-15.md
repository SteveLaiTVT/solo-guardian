# TASK-017/018/019: 错误处理基础设施

## 任务概述

实现跨后端和前端的标准化错误处理基础设施。

## 变更内容

### TASK-017: 共享错误码和类型 (已完成)

**文件**: `packages/types/src/errors.ts`

- ErrorCategory 枚举 (VALIDATION, AUTH, BUSINESS, NOT_FOUND, CONFLICT, RATE_LIMIT, SYSTEM)
- ErrorCodes 对象 (包含所有错误码定义)
- ApiErrorResponse 接口
- isUserError 辅助函数

### TASK-018: 后端错误处理 (骨架已创建)

**新建文件**:
| 文件 | 描述 |
|------|------|
| `apps/backend/src/common/exceptions/business.exception.ts` | 业务异常类 |
| `apps/backend/src/common/filters/global-exception.filter.ts` | 全局异常过滤器 |
| `apps/backend/src/common/exceptions/index.ts` | 导出文件 |
| `apps/backend/src/common/filters/index.ts` | 导出文件 |
| `apps/backend/src/common/index.ts` | 导出文件 |

**修改文件**:
| 文件 | 变更 |
|------|------|
| `apps/backend/src/main.ts` | 注册 GlobalExceptionFilter |

### TASK-019: 前端错误处理 (骨架已创建)

**新建文件**:
| 文件 | 描述 |
|------|------|
| `packages/api-client/src/error-handler.ts` | API 错误解析 |
| `apps/user-web/src/hooks/useErrorHandler.ts` | 错误处理钩子 |
| `apps/user-web/src/components/ErrorBoundary.tsx` | React 错误边界 |
| `apps/user-web/src/i18n/locales/en/error.json` | 英文错误消息 |
| `apps/user-web/src/i18n/locales/zh/error.json` | 中文错误消息 |
| `apps/user-web/src/i18n/locales/ja/error.json` | 日文错误消息 |

**修改文件**:
| 文件 | 变更 |
|------|------|
| `packages/api-client/src/index.ts` | 导出 error-handler |
| `apps/user-web/src/i18n/index.ts` | 添加 error 命名空间 |

## 错误响应格式

```json
{
  "success": false,
  "error": {
    "code": "CONTACT_4002",
    "category": "BUSINESS",
    "message": "Contact limit reached",
    "i18nKey": "error.contact.limitReached",
    "details": { "currentCount": 5, "maxAllowed": 5 },
    "field": null,
    "timestamp": "2026-01-15T10:00:00Z"
  }
}
```

## 使用示例

### 后端抛出业务异常

```typescript
throw new BusinessException('CONTACT_LIMIT_REACHED', {
  details: { currentCount: count, maxAllowed: 5 },
});
```

### 前端处理错误

```typescript
const { handleError } = useErrorHandler();

try {
  await createContact.mutateAsync(data);
} catch (error) {
  const parsed = handleError(error);
  if (parsed.field) {
    setError(parsed.field, { message: parsed.message });
  }
}
```

## 下一步

1. B Session 填充 TODO(B) 标记
2. C Session 审查实现
3. 继续 TASK-020 (用户偏好数据库模型)
