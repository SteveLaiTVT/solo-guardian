# iter-006 Bugfix 完成记录

## 变更摘要

**日期**: 2026-01-15
**版本**: 1.5.0 → 1.5.1
**里程碑**: Emergency Contacts Complete + Bugfixes

## 修复的 Bug

| Bug ID | 标题 | 严重性 | 状态 |
|--------|------|--------|------|
| BUG-001 | 路由遮蔽 (Route Shadowing) | P0 | 已修复 |
| BUG-002 | 软删除唯一约束冲突 | P0 | 已修复 |
| BUG-003 | 稀疏优先级自动分配冲突 | P1 | 已修复 |
| BUG-004 | 重排序时唯一约束违反 | P1 | 已修复 |
| BUG-005 | 自动优先级超出有效范围 | P1 | 已修复 |

## Bug 详情

### BUG-001: 路由遮蔽
- **问题**: `@Put(':id')` 在 `@Put('reorder')` 之前，导致 reorder 端点不可访问
- **修复**: 调整路由顺序，将固定路由放在参数路由之前

### BUG-002: 软删除唯一约束
- **问题**: 标准唯一约束不考虑 `deletedAt`，软删除后无法重新添加相同邮箱
- **修复**: 使用部分唯一索引 (Partial Unique Index)，仅对 `deleted_at IS NULL` 的记录生效

### BUG-003: 稀疏优先级冲突
- **问题**: 使用 `count + 1` 分配优先级，在稀疏情况下会冲突
- **修复**: 改用 `max(priority) + 1`

### BUG-004: 重排序约束违反
- **问题**: 顺序执行 UPDATE 会导致临时唯一约束违反
- **修复**: 使用单个 UPDATE + CASE 表达式原子更新

### BUG-005: 优先级超范围
- **问题**: `max + 1` 可能产生 > 5 的优先级
- **修复**: 查找 1-5 范围内最低可用槽位

## E2E 测试建议

为防止回归，建议添加以下 E2E 测试:

| 测试 ID | 场景 | 覆盖 Bug |
|---------|------|----------|
| E2E-EC-001 | 软删除后重新创建 | BUG-002 |
| E2E-EC-002 | 交换优先级重排序 | BUG-004 |
| E2E-EC-003 | 删除后自动优先级 | BUG-003, BUG-005 |
| E2E-EC-004 | 5个联系人限制 | - |
| E2E-EC-005 | Reorder 端点可访问 | BUG-001 |

## DESIGN_STATE.yaml 更新

- 版本号: 1.5.0 → 1.5.1
- 新增 `bugfix_history` 部分记录所有修复
- 新增 `e2e_test_recommendations` 部分

## 下一步

1. PR 合并后，考虑在后续迭代添加 E2E 测试
2. 开始 iter-007 设计 (用户偏好系统 + 错误处理基础设施)
