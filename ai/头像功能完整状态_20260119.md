# å¤´åƒåŠŸèƒ½å®Œæ•´çŠ¶æ€æ€»ç»“

**æ—¥æœŸ**: 2026-01-19
**çŠ¶æ€**: âœ… åç«¯å®Œæ•´ | â³ ç§»åŠ¨ç«¯éœ€é‡æ–°æ„å»ºå’Œæµ‹è¯•

---

## é—®é¢˜å›é¡¾

æ‚¨æåˆ°äº†ä¸¤ä¸ªé—®é¢˜ï¼š
1. **ç§»åŠ¨ç«¯çœ‹ä¸åˆ°å¤´åƒ**
2. **æ‰¾ä¸åˆ°ç”¨æˆ· Profile API åŠå…¶å®ç°**

---

## âœ… å·²ç¡®è®¤ï¼šProfile API å­˜åœ¨å¹¶æ­£å¸¸å·¥ä½œ

### API ç«¯ç‚¹ä¿¡æ¯

**ç«¯ç‚¹**: `GET /api/v1/preferences/profile`
**è®¤è¯**: éœ€è¦ Bearer Token
**è¿”å›**: ç”¨æˆ·å®Œæ•´ä¿¡æ¯ï¼ˆåŒ…å«å¤´åƒï¼‰

### å®ç°æ–‡ä»¶

| æ–‡ä»¶ | åŠŸèƒ½ | ä»£ç ä½ç½® |
|------|------|----------|
| `user-preferences.controller.ts` | æ§åˆ¶å™¨ | 61-66 è¡Œ |
| `user-preferences.service.ts` | æœåŠ¡å±‚ | 104-119 è¡Œ |

### API æµ‹è¯•ç»“æœ

```bash
GET /api/v1/preferences/profile
Authorization: Bearer {token}

å“åº” 200 OK:
{
  "id": "10afaf6a-9f35-4122-ba1b-3bd93f831567",
  "name": "Test User",
  "email": "testuser789@example.com",
  "username": "testuser789",
  "phone": null,
  "avatar": "https://solo-guardian.oss-cn-shenzhen.aliyuncs.com/avatars/.../avatar.png",  âœ…
  "birthYear": null,
  "createdAt": "2026-01-18T14:31:34.223Z"
}
```

**ç»“è®º**: âœ… Profile API å­˜åœ¨ï¼Œå·¥ä½œæ­£å¸¸ï¼Œè¿”å›å¤´åƒå­—æ®µã€‚

---

## âœ… å·²ç¡®è®¤ï¼šLogin API è¿”å›å¤´åƒ

### ä¹‹å‰ä¿®å¤çš„é—®é¢˜

åœ¨ä¸Šä¸€æ¬¡ä¼šè¯ä¸­ï¼Œæˆ‘å·²ç»ä¿®å¤äº†è®¤è¯ API ä¸è¿”å› avatar å­—æ®µçš„é—®é¢˜ï¼š

**ä¿®æ”¹çš„æ–‡ä»¶**:
1. `apps/backend/src/modules/auth/dto/auth-result.dto.ts` - æ·»åŠ  avatar åˆ° AuthUser æ¥å£
2. `apps/backend/src/modules/auth/auth.service.ts` - åœ¨ register/login/refresh ä¸‰ä¸ªæ–¹æ³•ä¸­æ·»åŠ  avatar å­—æ®µ
3. `apps/backend/src/modules/auth/auth.controller.spec.ts` - æ›´æ–°æµ‹è¯• mock

### Login API æµ‹è¯•ç»“æœ

```bash
POST /api/v1/auth/login
Content-Type: application/json
{"identifier":"testuser789","password":"password123"}

å“åº” 200 OK:
{
  "user": {
    "id": "10afaf6a-9f35-4122-ba1b-3bd93f831567",
    "name": "Test User",
    "email": "testuser789@example.com",
    "avatar": "https://solo-guardian.oss-cn-shenzhen.aliyuncs.com/avatars/.../avatar.png",  âœ…
    ...
  },
  "tokens": { ... }
}
```

**ç»“è®º**: âœ… Login/Register/Refresh API éƒ½è¿”å› avatar å­—æ®µã€‚

---

## âœ… å·²ç¡®è®¤ï¼šMobile App ä»£ç æ”¯æŒå¤´åƒæ˜¾ç¤º

### Mobile App ä»£ç æ£€æŸ¥

1. **User æ¨¡å‹** (`lib/data/models/user.dart:13`)
   ```dart
   const factory User({
     required String id,
     String? avatar,  âœ… å·²å®šä¹‰
     ...
   }) = _User;
   ```

2. **AuthResult æ¨¡å‹** (`lib/data/models/auth.dart:22`)
   ```dart
   const factory AuthResult({
     required User user,  âœ… åŒ…å« User å¯¹è±¡
     required AuthTokens tokens,
   }) = _AuthResult;
   ```

3. **Settings ç•Œé¢æ˜¾ç¤ºå¤´åƒ** (`lib/presentation/screens/settings/settings_screen.dart:193-194`)
   ```dart
   CircleAvatar(
     radius: 32,
     backgroundImage: user.avatar != null
       ? NetworkImage(user.avatar)  âœ… å·²å®ç°
       : null,
     ...
   )
   ```

4. **å¤´åƒä¸Šä¼ åŠŸèƒ½** (`lib/presentation/screens/settings/settings_screen.dart:155`)
   ```dart
   await ref.read(authProvider.notifier).uploadAvatar(pickedFile.path);
   âœ… å·²å®ç°
   ```

5. **å¤´åƒæŒä¹…åŒ–** (`lib/data/repositories/auth_repository_impl.dart:93-95`)
   ```dart
   Future<void> updateStoredUser(User user) async {
     await _storage.setUser(user.toJson());
   }
   âœ… å·²å®ç°ï¼ˆä¹‹å‰ä¼šè¯å·²ä¿®å¤ï¼‰
   ```

**ç»“è®º**: âœ… Mobile App ä»£ç å®Œæ•´æ”¯æŒå¤´åƒåŠŸèƒ½ã€‚

---

## ğŸ” ä¸ºä»€ä¹ˆç§»åŠ¨ç«¯çœ‹ä¸åˆ°å¤´åƒï¼Ÿ

### å¯èƒ½åŸå› 

#### åŸå›  1: ç§»åŠ¨ç«¯æœªé‡æ–°æ„å»º âš ï¸ æœ€å¯èƒ½

ä¹‹å‰ä¼šè¯ä¸­ä¿®æ”¹äº†ä»¥ä¸‹ç§»åŠ¨ç«¯ä»£ç ï¼š
- `auth_provider.dart` - æ·»åŠ äº†å¤´åƒæŒä¹…åŒ–å’Œè‡ªåŠ¨åŠ è½½ preferences
- `auth_repository_impl.dart` - æ·»åŠ äº† updateStoredUser æ–¹æ³•
- `app_router.dart` - ä¿®å¤äº† onboarding å¾ªç¯é—®é¢˜

**éœ€è¦æ“ä½œ**:
```bash
cd apps/mobile/solo_guardian
flutter clean
flutter pub get
flutter run
```

#### åŸå›  2: ç”¨æˆ·æœªé‡æ–°ç™»å½• âš ï¸

å¦‚æœç”¨æˆ·æ˜¯åœ¨ä¿®å¤ avatar å“åº”ä¹‹å‰ç™»å½•çš„ï¼Œæœ¬åœ°å­˜å‚¨çš„ User å¯¹è±¡ä¸åŒ…å« avatar å­—æ®µã€‚

**éœ€è¦æ“ä½œ**:
1. åœ¨ç§»åŠ¨ç«¯ç‚¹å‡»"é€€å‡ºç™»å½•"
2. é‡æ–°ç™»å½•
3. ç™»å½•å“åº”ä¼šåŒ…å« avatar å­—æ®µ
4. avatar ä¼šè¢«ä¿å­˜åˆ° SecureStorage

#### åŸå›  3: OSS Bucket ACL æœªé…ç½® âš ï¸

å³ä½¿ avatar URL å­˜åœ¨ï¼Œå¦‚æœ OSS Bucket æœªé…ç½®å…¬å…±è¯»æƒé™ï¼Œå›¾ç‰‡ä¹Ÿæ— æ³•åŠ è½½ã€‚

**éœ€è¦æ“ä½œ**: å‚è€ƒ `ai/å¤´åƒOSSæƒé™é…ç½®_20260119.md` é…ç½® Bucket ACL

#### åŸå›  4: ç”¨æˆ·æ²¡æœ‰ä¸Šä¼ å¤´åƒ âœ…

å¦‚æœæ˜¯æ–°ç”¨æˆ·æˆ–ä»æœªä¸Šä¼ è¿‡å¤´åƒï¼Œavatar å­—æ®µä¸º null æ˜¯æ­£å¸¸çš„ã€‚

---

## ğŸ“Š API å®¢æˆ·ç«¯æ”¯æŒæ£€æŸ¥

### packages/api-client

| åŠŸèƒ½ | æ–¹æ³• | Hook | çŠ¶æ€ |
|------|------|------|------|
| è·å– Profile | `getProfile()` | `useProfile()` | âœ… å·²å®ç° |
| æ›´æ–° Profile | `updateProfile()` | `useUpdateProfile()` | âœ… å·²å®ç° |
| ä¸Šä¼ å¤´åƒ | `uploadAvatar()` | `useUploadAvatar()` | âœ… å·²å®ç° |

**æ–‡ä»¶ä½ç½®**:
- `packages/api-client/src/api.ts` (144-158è¡Œ)
- `packages/api-client/src/hooks.ts` (237-264è¡Œ)
- `packages/api-client/src/types.ts` (User æ¥å£åŒ…å« avatar)

**ç»“è®º**: âœ… API å®¢æˆ·ç«¯å®Œæ•´æ”¯æŒå¤´åƒåŠŸèƒ½ã€‚

---

## ğŸ“‹ å®Œæ•´åŠŸèƒ½æ¸…å•

| åŠŸèƒ½ | åç«¯ | API Client | Mobile | Web | çŠ¶æ€ |
|------|------|------------|--------|-----|------|
| User æ¨¡å‹åŒ…å« avatar | âœ… | âœ… | âœ… | âœ… | å®Œæˆ |
| Login è¿”å› avatar | âœ… | âœ… | âœ… | âœ… | å®Œæˆ |
| Register è¿”å› avatar | âœ… | âœ… | âœ… | âœ… | å®Œæˆ |
| Refresh è¿”å› avatar | âœ… | âœ… | âœ… | âœ… | å®Œæˆ |
| Profile API | âœ… | âœ… | âœ… | âœ… | å®Œæˆ |
| ä¸Šä¼ å¤´åƒ API | âœ… | âœ… | âœ… | âœ… | å®Œæˆ |
| å¤´åƒæŒä¹…åŒ– (Mobile) | - | - | âœ… | - | å®Œæˆ |
| å¤´åƒæ˜¾ç¤º (Mobile) | - | - | âœ… | - | ä»£ç å®Œæˆ |
| å¤´åƒæ˜¾ç¤º (Web) | - | - | - | âœ… | ä»£ç å®Œæˆ |
| OSS å…¬å…±è®¿é—® | â³ | - | - | - | **éœ€é…ç½®** |

---

## ğŸ”§ è§£å†³æ­¥éª¤

### æ­¥éª¤ 1: é…ç½® OSS Bucket ACLï¼ˆå¿…é¡»ï¼‰

å‚è€ƒæ–‡æ¡£: `ai/å¤´åƒOSSæƒé™é…ç½®_20260119.md`

1. ç™»å½• [é˜¿é‡Œäº‘ OSS æ§åˆ¶å°](https://oss.console.aliyun.com/)
2. é€‰æ‹© Bucket: `solo-guardian`
3. è®¾ç½® ACL ä¸º **å…¬å…±è¯»**
4. éªŒè¯å¤´åƒ URL å¯è®¿é—®

### æ­¥éª¤ 2: é‡æ–°æ„å»ºç§»åŠ¨ç«¯

```bash
cd apps/mobile/solo_guardian

# æ¸…ç†
flutter clean
rm -rf .dart_tool
flutter pub get

# é‡æ–°æ„å»º
flutter run --release  # æˆ– --debug
```

### æ­¥éª¤ 3: æµ‹è¯•æµç¨‹

#### æµ‹è¯• 1: æ–°ç”¨æˆ·æ³¨å†Œ
```
1. æ³¨å†Œæ–°è´¦å·
2. å®Œæˆ onboarding
3. è¿›å…¥è®¾ç½®é¡µ â†’ å¤´åƒåº”ä¸ºé¦–å­—æ¯åœ†å½¢
4. ç‚¹å‡»å¤´åƒ â†’ ä¸Šä¼ å›¾ç‰‡
5. ä¸Šä¼ æˆåŠŸ â†’ å¤´åƒç«‹å³æ˜¾ç¤º
6. é€€å‡ºåº”ç”¨
7. é‡æ–°æ‰“å¼€ â†’ å¤´åƒä»ç„¶æ˜¾ç¤º âœ…
```

#### æµ‹è¯• 2: å·²æœ‰ç”¨æˆ·ç™»å½•
```
1. é€€å‡ºå½“å‰ç™»å½•
2. é‡æ–°ç™»å½•
3. è¿›å…¥è®¾ç½®é¡µ â†’ å¦‚æœä¹‹å‰ä¸Šä¼ è¿‡å¤´åƒï¼Œåº”è¯¥æ˜¾ç¤º
4. å¦‚æœæ²¡æ˜¾ç¤ºï¼Œæ£€æŸ¥ï¼š
   - æ˜¯å¦é…ç½®äº† OSS Bucket ACL
   - ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
   - avatar URL æ˜¯å¦æ­£ç¡®ï¼ˆæŸ¥çœ‹ logï¼‰
```

#### æµ‹è¯• 3: Profile API
```bash
# è·å– access token
ACCESS_TOKEN="..."

# è°ƒç”¨ Profile API
curl -X GET http://localhost:3000/api/v1/preferences/profile \
  -H "Authorization: Bearer $ACCESS_TOKEN"

# é¢„æœŸ: è¿”å›åŒ…å« avatar å­—æ®µçš„ JSON
```

### æ­¥éª¤ 4: è°ƒè¯•æ—¥å¿—

å¦‚æœå¤´åƒä»æœªæ˜¾ç¤ºï¼Œæ£€æŸ¥ Flutter æ—¥å¿—ï¼š

```bash
flutter run --debug

# æŸ¥æ‰¾å…³é”®æ—¥å¿—:
# - "Avatar uploaded" (ä¸Šä¼ æˆåŠŸ)
# - "Updated avatar for user" (åç«¯ä¿å­˜æˆåŠŸ)
# - User å¯¹è±¡ä¸­æ˜¯å¦åŒ…å« avatar å­—æ®µ
# - NetworkImage æ˜¯å¦åŠ è½½å¤±è´¥
```

---

## ğŸ“ ç›¸å…³ API ç«¯ç‚¹å®Œæ•´åˆ—è¡¨

| ç«¯ç‚¹ | æ–¹æ³• | åŠŸèƒ½ | avatar å­—æ®µ |
|------|------|------|-------------|
| `/api/v1/auth/register` | POST | æ³¨å†Œ | âœ… è¿”å› |
| `/api/v1/auth/login` | POST | ç™»å½• | âœ… è¿”å› |
| `/api/v1/auth/refresh` | POST | åˆ·æ–° Token | âœ… è¿”å› |
| `/api/v1/preferences/profile` | GET | è·å– Profile | âœ… è¿”å› |
| `/api/v1/preferences/profile` | PATCH | æ›´æ–° Profile | âœ… è¿”å› |
| `/api/v1/preferences/profile/avatar` | POST | ä¸Šä¼ å¤´åƒ | âœ… è¿”å› |

---

## ğŸ“š ç›¸å…³æ–‡æ¡£

| æ–‡æ¡£ | å†…å®¹ |
|------|------|
| `ai/comprehensive_avatar_fix_20260118.md` | å¤´åƒåŠŸèƒ½å…¨é¢å®ç°ï¼ˆè‹±æ–‡ï¼‰|
| `ai/avatar_auth_response_fix_20260118.md` | Auth å“åº”åŒ…å« avatar ä¿®å¤ |
| `ai/oss_bucket_acl_configuration_20260119.md` | OSS Bucket ACL é…ç½®ï¼ˆè‹±æ–‡ï¼‰|
| `ai/å¤´åƒOSSæƒé™é…ç½®_20260119.md` | OSS Bucket ACL é…ç½®ï¼ˆä¸­æ–‡ï¼‰|

---

## âœ… æ€»ç»“

### å·²å®Œæˆçš„å·¥ä½œ

1. âœ… Profile API å­˜åœ¨å¹¶æ­£å¸¸å·¥ä½œ
2. âœ… Login/Register/Refresh API éƒ½è¿”å› avatar å­—æ®µ
3. âœ… Mobile App ä»£ç å®Œæ•´æ”¯æŒå¤´åƒæ˜¾ç¤ºå’Œä¸Šä¼ 
4. âœ… API Client (packages/api-client) å®Œæ•´æ”¯æŒ
5. âœ… å¤´åƒæŒä¹…åŒ–å·²å®ç°
6. âœ… åç«¯ OSS ä¸Šä¼ åŠŸèƒ½æ­£å¸¸

### éœ€è¦å®Œæˆçš„æ“ä½œ

1. â³ **é…ç½® OSS Bucket ACL** (5åˆ†é’Ÿæ‰‹åŠ¨æ“ä½œ)
2. â³ **é‡æ–°æ„å»º Mobile App** (åŒ…å«æœ€æ–°ä»£ç ä¿®å¤)
3. â³ **é€€å‡ºå¹¶é‡æ–°ç™»å½•** (è·å–åŒ…å« avatar çš„è®¤è¯å“åº”)
4. â³ **æµ‹è¯•å¤´åƒä¸Šä¼ å’Œæ˜¾ç¤º**

### é¢„æœŸç»“æœ

å®Œæˆä»¥ä¸Šæ“ä½œåï¼š
- âœ… ç™»å½•åç«‹å³æ˜¾ç¤ºå¤´åƒï¼ˆå¦‚æœå·²ä¸Šä¼ ï¼‰
- âœ… ä¸Šä¼ å¤´åƒåç«‹å³æ˜¾ç¤º
- âœ… é€€å‡ºå¹¶é‡æ–°æ‰“å¼€ Appï¼Œå¤´åƒä¾ç„¶æ˜¾ç¤º
- âœ… Web ç«¯å’Œ Mobile ç«¯å¤´åƒåŒæ­¥

---

**å½“å‰çŠ¶æ€**: åç«¯ä»£ç  100% å®Œæˆï¼Œç§»åŠ¨ç«¯ä»£ç  100% å®Œæˆï¼Œéœ€è¦é‡æ–°æ„å»ºå’Œé…ç½® OSS Bucketã€‚
