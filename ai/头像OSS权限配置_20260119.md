# 头像 OSS 权限配置问题修复

**日期**: 2026-01-19
**问题**: 头像上传成功但无法公开访问
**状态**: ✅ 上传已修复 | ❌ 需配置 Bucket ACL

---

## 问题现象

用户反馈：在 user-web 和 mobile 端访问头像 URL 时，浏览器返回 AccessDenied 错误。

```xml
<Error>
  <Code>AccessDenied</Code>
  <Message>You have no right to access this object because of bucket acl.</Message>
</Error>
```

---

## 根本原因分析

阿里云 OSS Bucket `solo-guardian` 有两层 ACL 限制：

1. **Bucket 级别 ACL** 阻止公共读取访问
2. **Object 级别 ACL** 设置被禁用（无法设置 `x-oss-object-acl: public-read`）

导致：
- 文件上传成功 ✅
- 文件私密存储 ✅
- 文件无法公开访问 ❌

---

## 修复过程

### 第一步：移除导致错误的 ACL Header

**文件**: `apps/backend/src/modules/storage/storage.service.ts` (84-89行)

**修改前**（报错）:
```typescript
const result = await this.client.put(key, buffer, {
  headers: {
    'Content-Type': this.getMimeType(ext),
    'Cache-Control': 'max-age=31536000',
    'x-oss-object-acl': 'public-read', // ❌ 错误: "Put public object acl is not allowed"
  },
});
```

**修改后**（上传成功）:
```typescript
const result = await this.client.put(key, buffer, {
  headers: {
    'Content-Type': this.getMimeType(ext),
    'Cache-Control': 'max-age=31536000', // ✅ 上传成功，但 Bucket ACL 仍阻止访问
  },
});
```

### 测试结果

**上传测试** ✅ 成功
```bash
POST /api/v1/preferences/profile/avatar
返回: {
  "avatar": "https://solo-guardian.oss-cn-shenzhen.aliyuncs.com/avatars/10afaf6a-9f35-4122-ba1b-3bd93f831567/0b482db6-7a45-44de-a030-9285b200c0ba.png",
  ...
}
```

**访问测试** ❌ 403 Forbidden
```bash
curl -I https://solo-guardian.oss-cn-shenzhen.aliyuncs.com/avatars/.../avatar.png
返回: HTTP/1.1 403 Forbidden
```

---

## 解决方案

### 方案一：配置 Bucket 公共读权限（推荐用于开发/测试）

**适用场景**: 头像图片需要公开访问

**操作步骤**（阿里云控制台）:

1. 登录 [阿里云 OSS 控制台](https://oss.console.aliyun.com/)
2. 选择区域: **华南 1 (深圳)** / **cn-shenzhen**
3. 点击 Bucket: **solo-guardian**
4. 左侧菜单: **访问控制** → **读写权限 (ACL)**
5. 修改 ACL 为 **公共读**:
   - 读权限: 公共
   - 写权限: 私有
6. 点击 **保存**

**配置后效果**:
- `avatars/` 文件夹中的所有文件可公开访问
- 无需修改代码
- 头像 URL 可直接在浏览器访问
- Mobile/Web 应用可无认证显示头像

---

### 方案二：使用签名 URL（更安全）

**适用场景**: 需要保持 Bucket 私有但允许临时访问

**需要代码修改**:

在 `storage.service.ts` 中添加签名 URL 生成方法：

```typescript
async getSignedUrl(key: string, expiresInSeconds: number = 3600): Promise<string> {
  if (!this.client) {
    throw new Error('OSS storage is not configured');
  }

  try {
    const url = this.client.signatureUrl(key, {
      expires: expiresInSeconds, // 默认 1 小时
    });
    return url;
  } catch (error) {
    this.logger.error(`Failed to generate signed URL: ${error}`);
    throw new Error('Failed to generate signed URL');
  }
}
```

**优点**: 更安全，URL 有过期时间
**缺点**: 需要定期刷新 URL，实现更复杂

---

### 方案三：配置 CDN（推荐用于生产环境）

**适用场景**: 高流量应用，需要全球访问加速

**操作步骤**:

1. 在阿里云启用 CDN 服务
2. 配置 CDN 域名（如 `cdn.solo-guardian.com`）
3. 设置 CDN 允许公开访问
4. 更新 `.env` 文件:
   ```env
   ALIYUN_OSS_CDN_DOMAIN="https://cdn.solo-guardian.com"
   ```

**优点**:
- 性能最佳
- 大规模使用时成本更低
- 全球 CDN 边缘缓存

---

## 推荐方案

| 环境 | 推荐方案 | 原因 |
|------|----------|------|
| **开发/测试** | 方案一（公共读 Bucket） | 快速配置，无需代码修改 |
| **生产环境** | 方案三（CDN） | 性能好，规模化成本低 |

---

## 如何配置 Bucket ACL（详细步骤）

### 通过阿里云控制台（Web 界面）

1. 打开 [https://oss.console.aliyun.com/](https://oss.console.aliyun.com/)
2. 使用阿里云账号登录
3. 选择区域: **华南 1 (深圳)**
4. 点击 Bucket: **solo-guardian**
5. 左侧菜单: **访问控制** → **读写权限**
6. 修改 ACL 为 **公共读**:
   - 读权限 (Read): 公共 (Public)
   - 写权限 (Write): 私有 (Private)
7. 点击 **保存**
8. 确认修改

### 通过阿里云 CLI（替代方案）

```bash
# 安装阿里云 CLI
# brew install aliyun-cli  # macOS
# pip install aliyun-cli   # Python

# 配置凭证
aliyun configure

# 设置 Bucket ACL 为公共读
aliyun oss put-bucket-acl \
  --bucket solo-guardian \
  --acl public-read
```

---

## 配置后验证步骤

```bash
# 1. 上传新头像
curl -X POST http://localhost:3000/api/v1/preferences/profile/avatar \
  -H "Authorization: Bearer $ACCESS_TOKEN" \
  -F "avatar=@test.png" \
  | jq '.avatar'

# 预期输出: "https://solo-guardian.oss-cn-shenzhen.aliyuncs.com/avatars/..."

# 2. 测试公共访问
curl -I "第1步返回的头像URL"

# 预期输出: HTTP/1.1 200 OK (而不是 403)
```

---

## 代码修改总结

| 文件 | 修改内容 | 行号 |
|------|----------|------|
| `apps/backend/src/modules/storage/storage.service.ts` | 移除 `x-oss-object-acl: public-read` header | 84-89 |

**修改原因**: Bucket 禁用了 object 级别的 ACL 设置，会导致上传错误。

---

## 当前状态

| 功能 | 状态 |
|------|------|
| 上传功能 | ✅ 正常工作 |
| 文件存储 | ✅ 正常工作 |
| URL 生成 | ✅ 正常工作 |
| Auth 响应包含 avatar | ✅ 正常工作 |
| 公共访问 | ❌ **被 Bucket ACL 阻止** |

**需要操作**: 配置 OSS Bucket ACL 允许公共读访问（阿里云控制台 5 分钟手动操作）

**配置后**: ✅ 所有头像功能将完整工作

---

## 相关文档

- [头像认证响应修复](./avatar_auth_response_fix_20260118.md) - Auth 接口现在包含 avatar 字段
- [头像功能全面实现](./comprehensive_avatar_fix_20260118.md) - 头像系统全貌
- [OSS Bucket ACL 配置](./oss_bucket_acl_configuration_20260119.md) - 英文详细文档

---

**总结**: 后端代码已完成并正常工作。Bucket 配置是一次性手动设置任务（5分钟），完成后所有头像功能将正常运行。
