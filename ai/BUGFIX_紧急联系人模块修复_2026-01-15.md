# 紧急联系人模块 Bug 修复

## 问题来源

代码审查发现的三个问题。

## Bug 1: 路由遮蔽 (Route Shadowing)

### 问题
`@Put(':id')` 定义在 `@Put('reorder')` 之前，导致 `PUT /api/v1/emergency-contacts/reorder` 被 `:id` 处理器捕获（id='reorder'），使重排序端点无法访问。

### 修复
将 `@Put('reorder')` 移动到 `@Put(':id')` 之前。

### 文件
`emergency-contacts.controller.ts`

---

## Bug 2: 软删除的唯一约束冲突

### 问题
数据库模型有 `@@unique([userId, email])` 和 `@@unique([userId, priority])`，但不考虑 `deletedAt`。用户删除联系人后无法重新添加相同的邮箱或优先级，因为唯一约束仍然存在于软删除的记录上。

### 修复
- 移除 Prisma schema 中的标准唯一约束
- 创建部分唯一索引（Partial Unique Index），仅在 `deleted_at IS NULL` 时生效

### 迁移 SQL
```sql
DROP INDEX IF EXISTS "emergency_contacts_user_id_email_key";
DROP INDEX IF EXISTS "emergency_contacts_user_id_priority_key";

CREATE UNIQUE INDEX "emergency_contacts_user_id_email_active_key"
ON "emergency_contacts" ("user_id", "email")
WHERE "deleted_at" IS NULL;

CREATE UNIQUE INDEX "emergency_contacts_user_id_priority_active_key"
ON "emergency_contacts" ("user_id", "priority")
WHERE "deleted_at" IS NULL;
```

### 文件
- `schema.prisma`
- `migrations/20260115140000_fix_emergency_contact_unique_constraints/migration.sql`

---

## Bug 3: 自动优先级冲突

### 问题
优先级自动分配使用 `count + 1`，假设优先级是连续的。删除后优先级可能稀疏（如 1,2,4,5），此时 count=4，新联系人被分配优先级 5，与现有联系人冲突。

### 修复
使用 `max(priority) + 1` 而不是 `count + 1`。

### 代码变更
```typescript
// 旧代码
const priority = dto.priority ?? (count + 1);

// 新代码
let priority = dto.priority;
if (priority === undefined) {
  const maxPriority = await this.contactsRepository.getMaxPriority(userId);
  priority = maxPriority + 1;
}
```

### 文件
- `emergency-contacts.repository.ts` - 添加 `getMaxPriority()` 方法
- `emergency-contacts.service.ts` - 使用新方法

---

## Bug 4: 重排序时唯一约束冲突 (P1)

### 问题
`updatePriorities` 方法使用事务中的多个独立 UPDATE 语句。当交换优先级时（如 A:1→2, B:2→1），第一个 UPDATE 会在第二个完成前违反唯一约束，导致 500 错误。

### 修复
使用单个 UPDATE 语句配合 CASE 表达式，原子性地更新所有优先级：

```typescript
// 使用 Prisma.sql 构建参数化查询
const caseFragments = updates.map(
  (u) => Prisma.sql`WHEN id = ${u.id}::uuid THEN ${u.priority}`,
);
const caseExpression = Prisma.sql`CASE ${Prisma.join(caseFragments, ' ')} END`;

await this.prisma.$executeRaw`
  UPDATE emergency_contacts
  SET priority = ${caseExpression},
      updated_at = NOW()
  WHERE id IN (${idList})
`;
```

### 文件
- `emergency-contacts.repository.ts` - 重写 `updatePriorities()` 方法

---

## Git 提交

```
fix(backend): fix emergency contacts bugs from code review

Task: TASK-015 bugfix
```

## 验证

| 检查项 | 状态 |
|--------|------|
| TypeScript 编译 | ✅ 通过 |
| 迁移应用 | ✅ 成功 |
| Prisma 客户端生成 | ✅ 成功 |
