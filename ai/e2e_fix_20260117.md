# E2E 测试修复 - 2026-01-17

## 问题描述
用户请求确保 E2E 测试能够正常工作。

## 修改内容

### 1. 修复 package.json 依赖问题
- 文件: `e2e/package.json`
- 问题: 存在重复的 `@playwright/test` 依赖项
- 修复: 移除重复项，将依赖移至 `devDependencies`

### 2. 创建认证状态存储目录
- 新建: `e2e/.auth/.gitkeep`
- 用途: 存储 Playwright 认证状态文件

### 3. 更新 .gitignore
- 文件: `.gitignore`
- 添加: E2E 测试产物忽略规则
  - `e2e/.auth/*` (排除 `.gitkeep`)
  - `e2e/playwright-report/`
  - `e2e/test-results/`

### 4. 修复 Playwright 配置
- 文件: `e2e/playwright.config.ts`
- 修复: `globalSetup` 和 `globalTeardown` 路径从 `require.resolve()` 改为直接字符串路径

### 5. 修复测试夹具路径
- 文件: `e2e/fixtures/test-fixtures.ts`
- 修复: `STORAGE_STATE_PATH` 从 `'e2e/.auth/user.json'` 改为 `'.auth/user.json'`
- 修复: `expectError` 方法参数类型支持 `string | RegExp`

### 6. 添加健康检查端点
- 新建: `apps/backend/src/modules/health/health.controller.ts`
- 新建: `apps/backend/src/modules/health/health.module.ts`
- 新建: `apps/backend/src/modules/health/index.ts`
- 修改: `apps/backend/src/app.module.ts` 添加 HealthModule

### 7. 修复 TypeScript 编译错误
- 文件: `apps/backend/src/modules/auth/oauth/apple-oauth.provider.ts`
- 修复: 类型转换使用 `as unknown as AppleIdTokenClaims`

### 8. 优化测试脚本
- 文件: `e2e/package.json`
- 优化: 默认只运行 chromium 浏览器测试（更快）
- 新增: `test:all-browsers` 命令运行所有浏览器测试

## 运行 E2E 测试

### 前提条件
1. PostgreSQL 数据库运行中
2. 后端 `.env` 配置完成
3. 已执行 `pnpm run prisma:generate`

### 运行方式一：手动启动服务
```bash
# 终端1: 启动后端
cd apps/backend && pnpm run start:dev

# 终端2: 启动前端
cd apps/user-web && pnpm run dev

# 终端3: 运行测试
cd e2e && pnpm test
```

### 运行方式二：自动启动服务
```bash
cd e2e && pnpm test
# Playwright 会自动启动后端和前端
```

### 测试命令
- `pnpm test` - 运行 chromium 测试
- `pnpm test:all-browsers` - 运行所有浏览器测试
- `pnpm test:ui` - 打开 Playwright UI
- `pnpm test:headed` - 有界面运行测试
- `pnpm test:auth` - 只运行认证测试
- `pnpm test:checkin` - 只运行签到测试

## 第二次修复 - 测试选择器更新

### 问题
根据 Playwright 测试报告，测试因选择器不匹配而失败。

### 修复的选择器问题

1. **登录页面标题选择器**
   - 问题: 测试期望 `h2` 但实际是 `h3`
   - 修复: 使用 `h3[data-slot="card-title"]` 选择器

2. **用户问候语选择器**
   - 问题: 测试期望 `/hello|welcome|hi/i` 但实际是 "Good morning/afternoon/evening!"
   - 修复: 使用 `/good morning|good afternoon|good evening/i`

3. **设置页面测试**
   - 问题: 测试期望 timezone 设置但实际没有
   - 修复: 更新测试以匹配实际的设置页面结构

4. **历史页面测试**
   - 问题: 测试期望仪表盘上有历史区域但实际是独立页面
   - 修复: 更新测试以导航到 `/history` 页面

### 添加的 data-testid 属性

1. `apps/user-web/src/components/check-in/CheckInButton.tsx`
   - 添加: `data-testid="check-in-button"`

2. `apps/user-web/src/components/check-in/StatusCard.tsx`
   - 添加: `data-testid="check-in-status"`

3. `apps/user-web/src/components/history/HistoryItem.tsx`
   - 添加: `data-testid="history-item"`

## 第三次修复 - 更多选择器修复

### 问题
根据第二次测试报告，17个测试仍然失败。

### 修复内容

1. **历史页面导航测试**
   - 问题: History链接只在移动端导航中显示 (`md:hidden`)
   - 修复: 改为直接导航到 `/history` 页面并验证标题

2. **紧急联系人表单选择器**
   - 问题: 测试使用 `input[name="name"]` 但实际是 `input#name`
   - 修复: 使用 ID 选择器 (`input#name`, `input#email`)

3. **紧急联系人验证错误**
   - 问题: 测试期望 `.text-red-500` 但实际使用 `.text-destructive`
   - 修复: 更新为 `.text-destructive`

4. **设置页面选择器**
   - 修复: 使用更精确的 `h3:has-text()` 选择器
   - 添加: 新的 "Sign out" 按钮测试
