// ============================================================
// Prisma Schema for Solo Guardian
// @task TASK-001-A, TASK-005, TASK-014, TASK-020, TASK-023, TASK-046
// @design_state_version 3.7.0
// ============================================================

generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================================
// UserRole Enum - User roles for RBAC
// @task TASK-046
// @design_state_version 3.7.0
// ============================================================
// DONE(B): Created UserRole enum for RBAC - TASK-046
enum UserRole {
  user // Regular user (default)
  caregiver // Can care for multiple elders
  admin // System administrator
  super_admin // Super administrator with full access
}

// ============================================================
// UserStatus Enum - User account status
// @task TASK-046
// @design_state_version 3.7.0
// ============================================================
// DONE(B): Created UserStatus enum - TASK-046
enum UserStatus {
  active // Active user
  suspended // Suspended by admin
  deleted // Soft deleted
}

// ============================================================
// User Model
// @task TASK-065, TASK-075
// ============================================================
model User {
  id           String     @id @default(uuid())
  email        String?    @unique
  username     String?    @unique
  phone        String?    @unique
  passwordHash String     @map("password_hash")
  name         String
  birthYear    Int?       @map("birth_year") // Year of birth for age calculation
  role         UserRole   @default(user)
  status       UserStatus @default(active)
  createdAt    DateTime   @default(now()) @map("created_at")
  updatedAt    DateTime   @updatedAt @map("updated_at")

  refreshTokens     RefreshToken[]
  checkIns          CheckIn[]
  checkInSettings   CheckInSettings?
  emergencyContacts EmergencyContact[]    @relation("UserContacts")
  preferences       UserPreferences?
  alerts            Alert[]
  caregivingFor     CaregiverRelation[]   @relation("CaregiverUser")
  caredByUsers      CaregiverRelation[]   @relation("ElderUser")
  caretakerCheckIns CheckIn[]             @relation("CaretakerCheckIns")
  invitations       CaregiverInvitation[]
  linkedAsContact   EmergencyContact[]    @relation("LinkedContacts")

  @@index([role])
  @@index([status])
  @@index([username])
  @@index([phone])
  @@map("users")
}

// ============================================================
// RefreshToken Model
// ============================================================
model RefreshToken {
  id        String   @id @default(uuid())
  tokenHash String   @unique @map("token_hash")
  userId    String   @map("user_id")
  expiresAt DateTime @map("expires_at")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([tokenHash])
  @@map("refresh_tokens")
}

// ============================================================
// CheckIn Model - Daily safety check-in records
// @task TASK-005, TASK-060
// @design_state_version 3.8.0
// ============================================================
model CheckIn {
  id                     String   @id @default(uuid())
  userId                 String   @map("user_id")
  checkInDate            String   @map("check_in_date") // YYYY-MM-DD format
  checkedInAt            DateTime @default(now()) @map("checked_in_at")
  note                   String?  @db.VarChar(500)
  // DONE(B): Added caretaker check-in tracking - TASK-060
  checkedInByCaretakerId String?  @map("checked_in_by_caretaker_id")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")

  user      User  @relation(fields: [userId], references: [id], onDelete: Cascade)
  caretaker User? @relation("CaretakerCheckIns", fields: [checkedInByCaretakerId], references: [id], onDelete: SetNull)

  @@unique([userId, checkInDate]) // One check-in per day per user
  @@index([userId])
  @@index([checkInDate])
  @@map("check_ins")
}

// ============================================================
// CheckInSettings Model - User preferences for check-in
// @task TASK-005, TASK-029
// ============================================================
model CheckInSettings {
  id              String   @id @default(uuid())
  userId          String   @unique @map("user_id")
  deadlineTime    String   @default("10:00") @map("deadline_time") // HH:mm format
  reminderTime    String   @default("09:00") @map("reminder_time") // HH:mm format
  reminderEnabled Boolean  @default(true) @map("reminder_enabled")
  timezone        String   @default("Asia/Shanghai")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  // DONE(B): Added lastReminderSentAt field - TASK-029
  lastReminderSentAt DateTime? @map("last_reminder_sent_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("check_in_settings")
}

// ============================================================
// EmergencyContact Model - Emergency contacts for alert notifications
// @task TASK-014, TASK-029, TASK-036, TASK-065
// NOTE: Unique constraints on (userId, email) and (userId, priority) are
//       implemented as partial indexes in migration to exclude soft-deleted
//       records. See migration: fix_emergency_contact_unique_constraints
// ============================================================
model EmergencyContact {
  id         String    @id @default(uuid())
  userId     String    @map("user_id")
  name       String
  email      String
  phone      String?
  priority   Int       @default(1) // 1-5, notification order
  isVerified Boolean   @default(false) @map("is_verified")
  isActive   Boolean   @default(true) @map("is_active")
  createdAt  DateTime  @default(now()) @map("created_at")
  updatedAt  DateTime  @updatedAt @map("updated_at")
  deletedAt  DateTime? @map("deleted_at")

  // DONE(B): Added verification token fields - TASK-029
  verificationToken          String?   @map("verification_token")
  verificationTokenExpiresAt DateTime? @map("verification_token_expires_at")

  // DONE(B): Added phone verification fields - TASK-036
  phoneVerified     Boolean             @default(false) @map("phone_verified")
  phoneOtp          String?             @map("phone_otp")
  phoneOtpExpiresAt DateTime?           @map("phone_otp_expires_at")
  preferredChannel  NotificationChannel @default(email) @map("preferred_channel")

  // DONE(B): Added linked user fields - TASK-065
  linkedUserId          String?   @map("linked_user_id")
  invitationToken       String?   @unique @map("invitation_token")
  invitationSentAt      DateTime? @map("invitation_sent_at")
  invitationAcceptedAt  DateTime? @map("invitation_accepted_at")

  user          User           @relation("UserContacts", fields: [userId], references: [id], onDelete: Cascade)
  linkedUser    User?          @relation("LinkedContacts", fields: [linkedUserId], references: [id], onDelete: SetNull)
  // DONE(B): Add notifications relation - TASK-023
  notifications Notification[]

  // Unique constraints are partial indexes (see migration)
  // Only active (non-deleted) contacts have uniqueness enforced
  @@index([userId, isActive])
  @@index([userId, deletedAt]) // For efficient queries on active contacts
  @@index([verificationToken]) // For quick token lookup during verification
  @@index([linkedUserId]) // For efficient queries on linked contacts
  @@map("emergency_contacts")
}

// ============================================================
// UserPreferences Model - User preferences and feature toggles
// @task TASK-020
// @design_state_version 1.6.0
// ============================================================
model UserPreferences {
  id     String @id @default(uuid())
  userId String @unique @map("user_id")
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // New feature behavior
  preferFeaturesOn Boolean @default(false) @map("prefer_features_on")

  // Visual preferences
  theme         String  @default("standard") // "standard" | "warm" | "nature" | "ocean"
  fontSize      Int     @default(16) @map("font_size")
  highContrast  Boolean @default(false) @map("high_contrast")
  reducedMotion Boolean @default(false) @map("reduced_motion")
  warmColors    Boolean @default(false) @map("warm_colors")

  // Core feature toggles
  hobbyCheckIn Boolean @default(false) @map("hobby_check_in")
  familyAccess Boolean @default(false) @map("family_access")

  // Flexible optional features
  optionalFeatures Json @default("{}") @map("optional_features")

  // Onboarding
  onboardingCompleted Boolean @default(false) @map("onboarding_completed")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@map("user_preferences")
}

// ============================================================
// AlertStatus Enum - Status of missed check-in alerts
// @task TASK-023
// @design_state_version 1.8.0
// ============================================================
// DONE(B): Created AlertStatus enum - TASK-023
enum AlertStatus {
  triggered // Alert created, notifications queued
  notified // All notifications sent
  resolved // User checked in late
  expired // Alert expired without resolution (next day)
}

// ============================================================
// NotificationChannel Enum - Notification delivery channel
// @task TASK-023
// @design_state_version 1.8.0
// ============================================================
// DONE(B): Created NotificationChannel enum - TASK-023
enum NotificationChannel {
  email // Email notification (MVP)
  sms // SMS notification (future)
}

// ============================================================
// NotificationStatus Enum - Status of notification delivery
// @task TASK-023
// @design_state_version 1.8.0
// ============================================================
// DONE(B): Created NotificationStatus enum - TASK-023
enum NotificationStatus {
  pending // Notification queued, not yet processed
  sent // Notification sent to provider
  delivered // Delivery confirmed (future)
  failed // Notification failed after retries
}

// ============================================================
// Alert Model - Missed check-in alerts
// @task TASK-023
// @design_state_version 1.8.0
// ============================================================
// DONE(B): Implemented Alert model - TASK-023
model Alert {
  id          String      @id @default(uuid())
  userId      String      @map("user_id")
  alertDate   String      @map("alert_date") // YYYY-MM-DD format
  status      AlertStatus @default(triggered)
  triggeredAt DateTime    @default(now()) @map("triggered_at")
  resolvedAt  DateTime?   @map("resolved_at")
  createdAt   DateTime    @default(now()) @map("created_at")
  updatedAt   DateTime    @updatedAt @map("updated_at")

  user          User           @relation(fields: [userId], references: [id], onDelete: Cascade)
  notifications Notification[]

  @@unique([userId, alertDate]) // One alert per day per user
  @@index([userId])
  @@index([status])
  @@map("alerts")
}

// ============================================================
// Notification Model - Notifications sent to emergency contacts
// @task TASK-023
// @design_state_version 1.8.0
// ============================================================
// DONE(B): Implemented Notification model - TASK-023
model Notification {
  id          String              @id @default(uuid())
  alertId     String              @map("alert_id")
  contactId   String?             @map("contact_id")
  channel     NotificationChannel @default(email)
  status      NotificationStatus  @default(pending)
  sentAt      DateTime?           @map("sent_at")
  deliveredAt DateTime?           @map("delivered_at")
  error       String?
  createdAt   DateTime            @default(now()) @map("created_at")
  updatedAt   DateTime            @updatedAt @map("updated_at")

  alert   Alert             @relation(fields: [alertId], references: [id], onDelete: Cascade)
  contact EmergencyContact? @relation(fields: [contactId], references: [id], onDelete: SetNull)

  @@index([alertId])
  @@index([status])
  @@map("notifications")
}

// ============================================================
// CaregiverRelation Model - Relationship between caregiver and elders
// @task TASK-046, TASK-057
// @design_state_version 3.8.0
// ============================================================
// DONE(B): Implemented CaregiverRelation model - TASK-046
// DONE(B): Added relationshipType and notes - TASK-057
model CaregiverRelation {
  id               String   @id @default(uuid())
  caregiverId      String   @map("caregiver_id")
  elderId          String   @map("elder_id")
  isAccepted       Boolean  @default(false) @map("is_accepted")
  relationshipType String   @default("caregiver") @map("relationship_type") // "caregiver" | "family" | "caretaker"
  permissions      Json     @default("{}") // Flexible permissions storage
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  caregiver User            @relation("CaregiverUser", fields: [caregiverId], references: [id], onDelete: Cascade)
  elder     User            @relation("ElderUser", fields: [elderId], references: [id], onDelete: Cascade)
  notes     CaregiverNote[]

  @@unique([caregiverId, elderId])
  @@index([caregiverId])
  @@index([elderId])
  @@map("caregiver_relations")
}

// ============================================================
// CaregiverNote Model - Daily observations from caretakers
// @task TASK-057
// @design_state_version 3.8.0
// ============================================================
// DONE(B): Implemented CaregiverNote model - TASK-057
model CaregiverNote {
  id         String   @id @default(uuid())
  relationId String   @map("relation_id")
  content    String   @db.VarChar(1000)
  noteDate   String   @map("note_date") // YYYY-MM-DD format
  createdAt  DateTime @default(now()) @map("created_at")
  updatedAt  DateTime @updatedAt @map("updated_at")

  relation CaregiverRelation @relation(fields: [relationId], references: [id], onDelete: Cascade)

  @@index([relationId])
  @@index([noteDate])
  @@map("caregiver_notes")
}

// ============================================================
// CaregiverInvitation Model - QR/Email/Phone invitation tokens
// @task TASK-057
// @design_state_version 3.8.0
// ============================================================
// DONE(B): Implemented CaregiverInvitation model - TASK-057
model CaregiverInvitation {
  id               String    @id @default(uuid())
  inviterId        String    @map("inviter_id")
  relationshipType String    @map("relationship_type") // "caregiver" | "family" | "caretaker"
  targetEmail      String?   @map("target_email")
  targetPhone      String?   @map("target_phone")
  token            String    @unique
  expiresAt        DateTime  @map("expires_at")
  acceptedAt       DateTime? @map("accepted_at")
  createdAt        DateTime  @default(now()) @map("created_at")

  inviter User @relation(fields: [inviterId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([inviterId])
  @@map("caregiver_invitations")
}

// ============================================================
// EmailTemplate Model - Email template storage (multi-language, themes)
// @task TASK-049
// @design_state_version 3.8.0
// ============================================================
// DONE(B): Implemented EmailTemplate model - TASK-049
model EmailTemplate {
  id          String   @id @default(uuid())
  code        String // "alert" | "reminder" | "verification"
  language    String   @default("en") // en, zh, ja
  subject     String
  htmlContent String   @map("html_content") @db.Text
  textContent String   @map("text_content") @db.Text
  theme       String   @default("standard") // "standard" | "warm"
  variables   Json     @default("[]") // List of variable names: ["userName", "contactName"]
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  @@unique([code, language])
  @@index([code])
  @@map("email_templates")
}

// ============================================================
// SmsTemplate Model - SMS template storage (multi-language)
// @task TASK-049
// @design_state_version 3.8.0
// ============================================================
// DONE(B): Implemented SmsTemplate model - TASK-049
model SmsTemplate {
  id        String   @id @default(uuid())
  code      String // "alert" | "reminder" | "verification"
  language  String   @default("en") // en, zh, ja
  content   String   @db.VarChar(320) // SMS length limit
  variables Json     @default("[]") // List of variable names
  isActive  Boolean  @default(true) @map("is_active")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  @@unique([code, language])
  @@index([code])
  @@map("sms_templates")
}
