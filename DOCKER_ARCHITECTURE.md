# Solo Guardian Docker 架构图

## 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                      Docker Host                            │
│                                                             │
│  ┌──────────────────────────────────────────────────────┐  │
│  │            Docker Compose 网络                        │  │
│  │           (solo-guardian-network)                     │  │
│  │                                                       │  │
│  │  ┌──────────────┐    ┌──────────────┐   ┌─────────┐ │  │
│  │  │  PostgreSQL  │    │    Redis     │   │ Backend │ │  │
│  │  │  (Database)  │◄───┤   (Queue)    │◄──┤  (API)  │ │  │
│  │  │              │    │              │   │         │ │  │
│  │  │  Port: 5432  │    │  Port: 6379  │   │Port:3000│ │  │
│  │  └──────┬───────┘    └──────────────┘   └────┬────┘ │  │
│  │         │                                     │      │  │
│  │         │        ┌──────────────┐            │      │  │
│  │         └────────┤ Volumes      │────────────┘      │  │
│  │                  │ • postgres_  │                    │  │
│  │                  │   data       │                    │  │
│  │                  │ • redis_data │                    │  │
│  │                  └──────────────┘                    │  │
│  └──────────────────────────────────────────────────────┘  │
│                           ▲                                 │
└───────────────────────────┼─────────────────────────────────┘
                            │
                    Port Mappings:
                    • 3000:3000  (API)
                    • 5432:5432  (DB)
                    • 6379:6379  (Redis)
                            │
                            │
┌───────────────────────────▼─────────────────────────────────┐
│                     External Access                          │
│                                                              │
│  ┌──────────────┐         ┌────────────────┐               │
│  │   Internet   │◄────────┤  Nginx/Caddy   │               │
│  │   (Vercel)   │  HTTPS  │  (Reverse      │               │
│  │              │         │   Proxy)       │               │
│  └──────────────┘         └────────────────┘               │
│                                   │                         │
│                                   │ HTTP                    │
│                                   ▼                         │
│                          localhost:3000                     │
└─────────────────────────────────────────────────────────────┘
```

## 服务详细说明

### 1. PostgreSQL 数据库

```
┌────────────────────────────┐
│      PostgreSQL 16         │
│      (solo-guardian-       │
│        postgres)           │
├────────────────────────────┤
│ 功能:                      │
│ • 用户数据存储              │
│ • 签到记录                  │
│ • 紧急联系人                │
│ • 告警历史                  │
├────────────────────────────┤
│ 端口: 5432 (可配置)         │
│ 用户: solo_guardian        │
│ 数据库: solo_guardian      │
│ 持久化: postgres_data      │
├────────────────────────────┤
│ 健康检查:                   │
│ pg_isready 每 10 秒         │
└────────────────────────────┘
```

### 2. Redis 缓存/队列

```
┌────────────────────────────┐
│       Redis 7              │
│   (solo-guardian-redis)    │
├────────────────────────────┤
│ 功能:                      │
│ • BullMQ 任务队列           │
│ • 定时签到提醒              │
│ • 告警通知队列              │
│ • Session 缓存             │
├────────────────────────────┤
│ 端口: 6379 (可配置)         │
│ 持久化: AOF + RDB          │
│ 数据卷: redis_data         │
├────────────────────────────┤
│ 健康检查:                   │
│ redis-cli ping 每 10 秒    │
└────────────────────────────┘
```

### 3. Backend API

```
┌────────────────────────────┐
│      NestJS Backend        │
│   (solo-guardian-backend)  │
├────────────────────────────┤
│ 功能:                      │
│ • RESTful API              │
│ • JWT 认证                 │
│ • 签到管理                  │
│ • 告警处理                  │
│ • 邮件/短信发送             │
├────────────────────────────┤
│ 端口: 3000 (可配置)         │
│ 路由: /api/v1/*            │
│ 健康检查: /api/health      │
├────────────────────────────┤
│ 依赖:                      │
│ • PostgreSQL (数据库)       │
│ • Redis (队列)             │
├────────────────────────────┤
│ 启动流程:                   │
│ 1. Prisma 迁移             │
│ 2. 启动 NestJS             │
│ 3. 连接数据库和 Redis      │
└────────────────────────────┘
```

## 数据流

### 1. 用户签到流程

```
┌─────────┐      ┌─────────┐      ┌──────────┐      ┌─────────┐
│ Vercel  │─────▶│ Backend │─────▶│PostgreSQL│      │  Redis  │
│Frontend │ HTTP │   API   │ SQL  │          │      │         │
└─────────┘      └────┬────┘      └──────────┘      └────┬────┘
                      │                                   │
                      │ 创建签到记录                       │
                      └───────────────────────────────────┘
                           更新签到状态缓存
```

### 2. 告警发送流程

```
┌─────────┐      ┌─────────┐      ┌─────────┐      ┌──────────┐
│ Cron    │      │ Backend │      │  Redis  │      │   SMTP   │
│ Job     │─────▶│  Check  │─────▶│  Queue  │─────▶│  Twilio  │
└─────────┘      └─────────┘      └─────────┘      └──────────┘
   每 5 分钟         检查超时         BullMQ 队列       发送通知
```

### 3. 数据持久化

```
┌──────────────┐
│ Docker Host  │
├──────────────┤
│              │
│  Volumes:    │
│              │
│  postgres_   │◄── PostgreSQL 数据
│  data/       │    (用户、签到、告警)
│              │
│  redis_      │◄── Redis 数据
│  data/       │    (队列、缓存)
│              │
└──────────────┘
```

## 网络配置

```
┌────────────────────────────────────────┐
│   solo-guardian-network (bridge)      │
├────────────────────────────────────────┤
│                                        │
│  postgres:5432  ◄───┐                 │
│                     │                  │
│  redis:6379     ◄───┼───► backend:3000│
│                     │                  │
│                     └────────────────► │
│                    内部 DNS 解析        │
│                                        │
└────────────────────────────────────────┘
          ▲
          │ 端口映射
          │
    Host: localhost:3000
```

## 部署场景

### 场景 1: 本地开发

```
┌──────────────┐
│ 开发者电脑    │
├──────────────┤
│              │
│ Docker       │◄── docker-compose up -d
│ Compose      │
│              │
│ • PostgreSQL │
│ • Redis      │
│ • Backend    │
│              │
└──────────────┘
```

### 场景 2: VPS 生产部署

```
┌─────────────────────────────────────┐
│           VPS/云服务器                │
├─────────────────────────────────────┤
│                                     │
│  ┌────────────┐   ┌──────────────┐ │
│  │   Nginx    │   │   Docker     │ │
│  │  (HTTPS)   │──▶│  Compose     │ │
│  └────────────┘   └──────────────┘ │
│        ▲                            │
│        │ SSL 证书                    │
└────────┼─────────────────────────────┘
         │
    ┌────▼─────┐
    │ Internet │
    └──────────┘
```

### 场景 3: Vercel + Docker (推荐)

```
┌─────────────┐         ┌──────────────┐
│   Vercel    │  HTTPS  │   VPS/Cloud  │
│  Frontend   │────────▶│   Backend    │
│             │         │   (Docker)   │
└─────────────┘         └──────────────┘
      ▲                        ▲
      │                        │
      │                        │
  ┌───┴────┐             ┌────┴─────┐
  │ GitHub │             │  Docker  │
  │  Repo  │             │ Compose  │
  └────────┘             └──────────┘
```

## 环境变量流

```
.env (配置文件)
    │
    ├─▶ POSTGRES_*      ──▶ PostgreSQL 容器
    │
    ├─▶ REDIS_*         ──▶ Redis 容器
    │
    └─▶ BACKEND_*       ──▶ Backend 容器
        ├─ DATABASE_URL ──▶ 连接 PostgreSQL
        ├─ REDIS_URL    ──▶ 连接 Redis
        ├─ JWT_*        ──▶ 认证配置
        ├─ SMTP_*       ──▶ 邮件服务
        └─ TWILIO_*     ──▶ 短信服务
```

## 端口映射策略

```yaml
# 默认端口
BACKEND_PORT=3000
POSTGRES_PORT=5432
REDIS_PORT=6379

# 自定义端口 (避免冲突)
BACKEND_PORT=8080    ──▶  localhost:8080  ──▶  container:8080
POSTGRES_PORT=5433   ──▶  localhost:5433  ──▶  container:5432
REDIS_PORT=6380      ──▶  localhost:6380  ──▶  container:6379
```

## 健康检查机制

```
┌─────────────────────────────────────┐
│         Health Check Flow           │
├─────────────────────────────────────┤
│                                     │
│  PostgreSQL ──▶ pg_isready          │
│     │              ↓                │
│     │          ✓ Ready              │
│     │              ↓                │
│     └──────────▶ Backend 等待        │
│                                     │
│  Redis ──▶ redis-cli ping           │
│     │              ↓                │
│     │          PONG                 │
│     │              ↓                │
│     └──────────▶ Backend 等待        │
│                                     │
│  Backend ──▶ /api/health            │
│                  ↓                  │
│          {"status":"ok"}            │
│                                     │
└─────────────────────────────────────┘
```

## 故障恢复

```
容器崩溃
    │
    ├─▶ restart: unless-stopped
    │       │
    │       └─▶ 自动重启容器
    │
    └─▶ depends_on + health check
            │
            └─▶ 等待依赖服务就绪
```

## 数据备份策略

```
┌─────────────┐
│   Cron Job  │
└──────┬──────┘
       │
       │ 每天 2:00 AM
       ▼
┌──────────────────┐      ┌─────────────┐
│ pg_dump          │─────▶│  backup-    │
│ (PostgreSQL)     │      │  YYYYMMDD   │
└──────────────────┘      │  .sql.gz    │
                          └─────────────┘
┌──────────────────┐               │
│ redis-cli save   │               │
│ (Redis)          │───────────────┘
└──────────────────┘

                          ┌─────────────┐
                          │  Cloud      │
                          │  Storage    │
                          │  (S3/OSS)   │
                          └─────────────┘
```

---

此架构图帮助理解 Solo Guardian 的 Docker 部署结构。
更多详情请参考 `DOCKER.md` 和 `DOCKER_CN.md`。
