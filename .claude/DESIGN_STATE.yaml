# ============================================================
# DESIGN_STATE - Single Source of Truth
# ============================================================
# Rules:
#   - Only A Session (Opus) can modify this file
#   - Must update version and updated_at on every change
#   - B/C Sessions can only read, not modify
#   - All design decisions must be recorded here
# ============================================================

meta:
  version: "3.5.0"
  updated_at: "2026-01-16"
  updated_by: "A Session"
  branch: "main"
  project_name: "Solo Guardian"
  description: "Safety check-in app for people living alone"
  milestone: "SMS, OAuth, and E2E Testing"

# ============================================================
# 1. Technical Architecture
# ============================================================
architecture:
  pattern: "Layered Architecture + Modular"
  
  backend:
    language: "TypeScript"
    framework: "NestJS"
    database: "PostgreSQL"
    cache: "Redis"
    orm: "Prisma"

  frontend_shared:
    language: "TypeScript"
    ui_framework: "React 18"
    state_management: "Zustand"
    styling: "Tailwind CSS"
    api_client: "TanStack Query + Axios"

  admin_web:
    base: "frontend_shared"
    routing: "React Router"
    ui_library: "Ant Design"

  user_web:
    base: "frontend_shared"
    routing: "React Router"
    ui_library: "shadcn/ui"
    i18n: "react-i18next"
    languages: ["en", "zh", "ja"]
    responsive: true
    breakpoints:
      mobile: "< 768px"
      tablet: "768px - 1024px"
      desktop: "> 1024px"

  mobile:
    android:
      language: "Kotlin"
      ui: "Jetpack Compose"
      architecture: "MVVM + Clean Architecture"
      di: "Hilt"
      networking: "Retrofit + OkHttp"
    ios:
      status: "planned"
      language: "Swift"
      ui: "SwiftUI"

# ============================================================
# 2. Business Modules
# ============================================================
modules:
  auth:
    status: "done"  # designing | in_progress | done | blocked
    owner: "B Session"
    description: "User authentication and authorization"
    skeleton_created: true
    skeleton_version: "0.2.0"
    completed_iteration: "iter-004"
    hardened: true
    features:
      - name: "Email/Password Login"
        priority: "P0"
        status: "done"
      - name: "JWT Token Management"
        priority: "P0"
        status: "done"
      - name: "Security Event Logging"
        priority: "P0"
        status: "done"
        added_in: "iter-002"
      - name: "Config Validation"
        priority: "P0"
        status: "done"
        added_in: "iter-002"
      - name: "JWT Auth Guard"
        priority: "P0"
        status: "done"
        added_in: "iter-004"
        description: "Protect endpoints with JWT authentication"
      - name: "OAuth (Google/Apple)"
        priority: "P1"
        status: "designing"
        started_iteration: "iter-011"
      - name: "Role-Based Access Control (RBAC)"
        priority: "P0"
        status: "pending"

  user:
    status: "pending"
    owner: null
    description: "User management"
    features:
      - name: "User CRUD"
        priority: "P0"
        status: "pending"
      - name: "Profile editing"
        priority: "P1"
        status: "pending"

  check_in:
    status: "done"  # designing | in_progress | done | blocked
    owner: "B Session"
    description: "Core check-in functionality - daily safety check-in"
    skeleton_created: true
    skeleton_version: "0.8.0"
    completed_iteration: "iter-003"
    features:
      - name: "Daily Check-in"
        priority: "P0"
        status: "done"
        description: "User can check in with one tap to confirm safety"
      - name: "Check-in Settings"
        priority: "P0"
        status: "done"
        description: "User can set daily deadline and reminder time"
      - name: "Check-in History"
        priority: "P0"
        status: "done"
        description: "View past check-in records"
      - name: "Today Status"
        priority: "P0"
        status: "done"
        description: "Check if user has checked in today"
      - name: "Overdue Detection"
        priority: "P0"
        status: "done"
        description: "Check if user is past deadline without check-in"
      - name: "Missed Check-in Detection"
        priority: "P1"
        status: "pending"
        description: "Scheduled job to detect missed check-ins (future)"
      - name: "Check-in Streak"
        priority: "P2"
        status: "pending"
        description: "Track consecutive check-in days (gamification)"

  emergency_contacts:
    status: "done"
    owner: "B Session"
    description: "Emergency contacts management - people to notify if user misses check-in"
    started_iteration: "iter-006"
    completed_iteration: "iter-006"
    skeleton_created: true
    skeleton_version: "0.1.0"
    features:
      - name: "Contact CRUD"
        priority: "P0"
        status: "done"
        description: "Add, edit, delete emergency contacts"
        completed_task: "TASK-015"
      - name: "Contact List"
        priority: "P0"
        status: "done"
        description: "View all emergency contacts"
        completed_task: "TASK-015"
      - name: "Contact Verification"
        priority: "P1"
        status: "pending"
        description: "Verify contact email/phone before activation"
      - name: "Contact Limit"
        priority: "P0"
        status: "done"
        description: "Maximum 5 emergency contacts per user"
        completed_task: "TASK-015"

  user_web:
    status: "done"
    owner: "B Session"
    description: "User-facing web application"
    started_iteration: "iter-005"
    completed_iteration: "iter-006"
    features:
      - name: "Login/Register"
        priority: "P0"
        status: "done"
        completed_task: "TASK-010"
      - name: "Check-in Dashboard"
        priority: "P0"
        status: "done"
        completed_task: "TASK-011"
      - name: "Check-in Settings"
        priority: "P0"
        status: "done"
        completed_task: "TASK-011"
      - name: "Check-in History"
        priority: "P0"
        status: "done"
        completed_task: "TASK-011"
      - name: "Mobile Responsive"
        priority: "P0"
        status: "done"
        completed_task: "TASK-011"
      - name: "Internationalization (i18n)"
        priority: "P0"
        status: "done"
        description: "Support for English, Chinese, Japanese"
        completed_task: "TASK-013"
      - name: "Emergency Contacts Page"
        priority: "P0"
        status: "done"
        description: "Manage emergency contacts in user-web"
        completed_task: "TASK-016"

  user_preferences:
    status: "done"
    owner: "B Session"
    description: "User preferences and feature toggles"
    started_iteration: "iter-007"
    completed_iteration: "iter-007"
    features:
      - name: "Feature Toggle System"
        priority: "P0"
        status: "done"
        description: "Users can enable/disable optional features"
        completed_task: "TASK-021"
      - name: "Visual Preferences"
        priority: "P0"
        status: "done"
        description: "Font size, high contrast, reduced motion"
        completed_task: "TASK-022"
      - name: "Onboarding Flow"
        priority: "P0"
        status: "done"
        description: "First-time user setup with feature selection"
        completed_task: "TASK-022"
      - name: "Settings Page"
        priority: "P0"
        status: "done"
        description: "Features and visual preferences sections"
        completed_task: "TASK-022"

  error_handling:
    status: "done"
    owner: "B Session"
    description: "Standardized error handling across backend and frontend"
    started_iteration: "iter-007"
    completed_iteration: "iter-007"
    features:
      - name: "Error Codes"
        priority: "P0"
        status: "done"
        description: "Shared error codes in packages/types"
        completed_task: "TASK-017"
      - name: "Backend Exception Filter"
        priority: "P0"
        status: "done"
        description: "BusinessException + GlobalExceptionFilter"
        completed_task: "TASK-018"
      - name: "Frontend Error Handler"
        priority: "P0"
        status: "done"
        description: "useErrorHandler hook with i18n messages"
        completed_task: "TASK-019"
      - name: "Error Boundary"
        priority: "P0"
        status: "done"
        description: "React error boundary for unexpected errors"
        completed_task: "TASK-019"

  alerts:
    status: "done"
    owner: "B Session"
    description: "Alert system for missed check-ins"
    started_iteration: "iter-008"
    completed_iteration: "iter-008"
    skeleton_created: true
    skeleton_version: "0.1.0"
    features:
      - name: "Alert Creation"
        priority: "P0"
        status: "done"
        description: "Create alert when user misses check-in deadline"
        completed_task: "TASK-027"
      - name: "Alert Resolution"
        priority: "P0"
        status: "done"
        description: "Resolve alert when user checks in (late check-in)"
        completed_task: "TASK-027"
      - name: "Alert History"
        priority: "P0"
        status: "done"
        description: "View past alerts for user"
        completed_task: "TASK-027"

  notifications:
    status: "done"
    owner: "B Session"
    description: "Notification delivery to emergency contacts"
    started_iteration: "iter-008"
    completed_iteration: "iter-008"
    skeleton_created: true
    skeleton_version: "0.1.0"
    features:
      - name: "Email Notifications"
        priority: "P0"
        status: "done"
        description: "Send email alerts to emergency contacts"
        completed_task: "TASK-025"
      - name: "Notification Queue"
        priority: "P0"
        status: "done"
        description: "Bull queue for reliable notification delivery"
        completed_task: "TASK-024"
      - name: "Notification History"
        priority: "P0"
        status: "done"
        description: "Track sent notifications and their status"
        completed_task: "TASK-026"
      - name: "SMS Notifications"
        priority: "P2"
        status: "pending"
        description: "Send SMS alerts (future)"

  missed_checkin_detector:
    status: "done"
    owner: "B Session"
    description: "Scheduled job to detect users who missed check-in"
    started_iteration: "iter-008"
    completed_iteration: "iter-008"
    skeleton_created: true
    skeleton_version: "0.1.0"
    features:
      - name: "Cron Job"
        priority: "P0"
        status: "done"
        description: "Run every minute to check for overdue users"
        completed_task: "TASK-028"
      - name: "Timezone-Aware Detection"
        priority: "P0"
        status: "done"
        description: "Respect user timezone when checking deadline"
        completed_task: "TASK-028"
      - name: "Alert Expiration"
        priority: "P0"
        status: "done"
        description: "Daily job to expire old alerts"
        completed_task: "TASK-028"

  reminder_notifications:
    status: "done"
    owner: "B Session"
    description: "Send reminder emails to users before their check-in deadline"
    started_iteration: "iter-009"
    completed_iteration: "iter-009"
    skeleton_created: true
    skeleton_version: "2.0.0"
    features:
      - name: "Reminder Cron Job"
        priority: "P0"
        status: "done"
        description: "Scheduled job to send reminders at user's reminderTime"
        completed_task: "TASK-029"
      - name: "Reminder Email"
        priority: "P0"
        status: "done"
        description: "Email template for check-in reminders"
        completed_task: "TASK-029"
      - name: "Reminder Tracking"
        priority: "P0"
        status: "done"
        description: "Track last reminder sent to prevent duplicates"
        completed_task: "TASK-029"

  contact_verification:
    status: "done"
    owner: "B Session"
    description: "Email verification for emergency contacts"
    started_iteration: "iter-009"
    completed_iteration: "iter-009"
    skeleton_created: true
    skeleton_version: "2.0.0"
    features:
      - name: "Verification Email"
        priority: "P0"
        status: "done"
        description: "Send verification email when contact is added"
        completed_task: "TASK-032"
      - name: "Verification Token"
        priority: "P0"
        status: "done"
        description: "Token-based verification with expiration"
        completed_task: "TASK-031"
      - name: "Verification Endpoint"
        priority: "P0"
        status: "done"
        description: "Public endpoint to verify contact"
        completed_task: "TASK-033"
      - name: "Resend Verification"
        priority: "P1"
        status: "done"
        description: "Allow resending verification email"
        completed_task: "TASK-031"

  sms_notifications:
    status: "in_progress"
    owner: "B Session"
    description: "SMS notifications for alerts (alternative to email)"
    started_iteration: "iter-010"
    skeleton_created: true
    skeleton_version: "3.4.0"
    features:
      - name: "SMS Provider Integration"
        priority: "P0"
        status: "done"
        description: "Integrate with Twilio or similar SMS provider"
        completed_task: "TASK-034"
      - name: "SMS Alert Notifications"
        priority: "P0"
        status: "done"
        description: "Send SMS to emergency contacts on missed check-in"
        completed_task: "TASK-035"
      - name: "Phone Number Verification"
        priority: "P1"
        status: "ready"
        description: "Verify phone numbers before sending SMS"
        task: "TASK-036"
      - name: "SMS Channel Selection"
        priority: "P1"
        status: "ready"
        description: "Allow contacts to choose email vs SMS"
        task: "TASK-037"

  oauth:
    status: "designing"
    owner: "A Session"
    description: "OAuth authentication with Google and Apple"
    started_iteration: "iter-011"
    skeleton_created: false
    features:
      - name: "Google OAuth"
        priority: "P0"
        status: "designing"
        description: "Sign in with Google"
      - name: "Apple OAuth"
        priority: "P1"
        status: "designing"
        description: "Sign in with Apple (required for iOS)"
      - name: "Account Linking"
        priority: "P1"
        status: "designing"
        description: "Link OAuth to existing email account"

  e2e_testing:
    status: "designing"
    owner: "A Session"
    description: "End-to-end testing infrastructure"
    started_iteration: "iter-012"
    skeleton_created: false
    features:
      - name: "Playwright Setup"
        priority: "P0"
        status: "designing"
        description: "Configure Playwright for E2E tests"
      - name: "Auth Flow Tests"
        priority: "P0"
        status: "designing"
        description: "Test login, register, logout flows"
      - name: "Check-in Flow Tests"
        priority: "P0"
        status: "designing"
        description: "Test check-in functionality"
      - name: "Contact Management Tests"
        priority: "P1"
        status: "designing"
        description: "Test emergency contacts CRUD"
      - name: "CI Integration"
        priority: "P0"
        status: "designing"
        description: "Run E2E tests in GitHub Actions"

# ============================================================
# 3. API Design Constraints
# ============================================================
api_constraints:
  style: "RESTful"
  versioning: "URL prefix (/api/v1)"

  naming:
    - "Use plural for resource names: /users, /posts"
    - "Use kebab-case: /user-profiles"
    - "Max 2 levels of nesting: /users/{id}/posts"

  response_format:
    success: |
      {
        "success": true,
        "data": { ... },
        "meta": { "page": 1, "total": 100 }
      }
    error: |
      {
        "success": false,
        "error": {
          "code": "AUTH_001",
          "message": "Token expired",
          "details": { ... }
        }
      }

  authentication:
    method: "Bearer Token (JWT)"
    header: "Authorization: Bearer <token>"
    refresh_strategy: "Refresh Token Rotation"

# ============================================================
# 4. Code Constraints (For B/C Session validation)
# ============================================================
code_constraints:
  general:
    - "No `any` type allowed (TypeScript)"
    - "All functions must have return type declaration"
    - "Single file < 300 lines"
    - "Single function < 50 lines"

  backend:
    - "Controller only does parameter validation and calls Service"
    - "Service contains business logic, does not directly access database"
    - "Repository handles database operations"
    - "All database operations must be in transactions"
    - "Sensitive operations must be logged"

  frontend:
    - "Use functional components + Hooks"
    - "Extract business logic to custom hooks"
    - "Separate UI components from business components"
    - "All API calls through api-client package"

  mobile:
    - "Separate UI from business logic (Compose + ViewModel)"
    - "Use StateFlow/SharedFlow for state management"
    - "Network requests through Repository layer"

# ============================================================
# 5. Current Iterations (Running in Parallel)
# ============================================================
current_iterations:
  - id: "iter-010"
    goal: "SMS Notifications"
    started_at: "2026-01-16"
    status: "designing"
    tasks:
      - id: "TASK-034"
        title: "Backend: SMS provider integration (Twilio)"
        status: "completed"
        priority: "P0"
        handoff: "HO-034-sms-provider.yaml"
        depends_on: []
        description: "Integrate Twilio SDK, configure credentials, create SmsService"
        skeleton_files:
          - "apps/backend/src/modules/sms/sms.service.ts"
          - "apps/backend/src/modules/sms/sms.module.ts"
          - "apps/backend/src/modules/sms/index.ts"
        review_verdict: "pass"
        completed_at: "2026-01-16"

      - id: "TASK-035"
        title: "Backend: SMS notification processor"
        status: "completed"
        priority: "P0"
        handoff: "HO-035-sms-processor.yaml"
        depends_on: ["TASK-034"]
        description: "Add SMS channel to notification queue processor"
        skeleton_files:
          - "apps/backend/src/modules/notifications/notification.processor.ts"
          - "apps/backend/src/modules/notifications/notification.module.ts"
          - "apps/backend/src/modules/notifications/notification.service.ts"
        skeleton_version: "3.2.1"
        review_verdict: "pass"
        completed_at: "2026-01-16"

      - id: "TASK-036"
        title: "Backend: Phone number verification"
        status: "completed"
        priority: "P1"
        handoff: "HO-036-phone-verification.yaml"
        depends_on: ["TASK-034"]
        description: "Verify phone numbers via SMS OTP"
        skeleton_files:
          - "apps/backend/src/modules/emergency-contacts/phone-verification.service.ts"
          - "apps/backend/src/modules/emergency-contacts/emergency-contacts.repository.ts"
          - "apps/backend/src/modules/emergency-contacts/emergency-contacts.controller.ts"
          - "apps/backend/src/modules/emergency-contacts/emergency-contacts.module.ts"
          - "apps/backend/src/modules/emergency-contacts/dto/verify-phone.dto.ts"
          - "apps/backend/src/modules/emergency-contacts/dto/contact-response.dto.ts"
          - "apps/backend/prisma/schema.prisma"
        skeleton_version: "3.4.0"
        completed_at: "2026-01-16"

      - id: "TASK-037"
        title: "Frontend: SMS settings UI"
        status: "completed"
        priority: "P1"
        handoff: "HO-037-sms-settings-ui.yaml"
        depends_on: ["TASK-036"]
        completed_at: "2026-01-16"
        description: "Add phone number and SMS preference to contact form"
        skeleton_files:
          - "apps/user-web/src/components/contacts/ContactCard.tsx"
          - "apps/user-web/src/components/contacts/ContactForm.tsx"
          - "apps/user-web/src/components/contacts/PhoneVerificationDialog.tsx"
          - "apps/user-web/src/i18n/locales/en/contacts.json"
          - "packages/api-client/src/types.ts"
          - "packages/api-client/src/api.ts"
          - "packages/api-client/src/hooks.ts"
        skeleton_version: "3.4.0"

  - id: "iter-011"
    goal: "OAuth Login (Google/Apple)"
    started_at: "2026-01-16"
    status: "implementing"
    tasks:
      - id: "TASK-038"
        title: "Backend: Google OAuth integration"
        status: "completed"
        priority: "P0"
        handoff: "HO-038-google-oauth.yaml"
        depends_on: []
        description: "Google OAuth strategy with BaseOAuthProvider pattern"
        completed_at: "2026-01-16"
        skeleton_files:
          - "apps/backend/src/modules/auth/oauth/oauth.types.ts"
          - "apps/backend/src/modules/auth/oauth/base-oauth.provider.ts"
          - "apps/backend/src/modules/auth/oauth/google-oauth.provider.ts"
          - "apps/backend/src/modules/auth/oauth/oauth.service.ts"
          - "apps/backend/src/modules/auth/oauth/oauth.controller.ts"
          - "apps/backend/src/modules/auth/oauth/oauth.module.ts"

      - id: "TASK-039"
        title: "Backend: Apple OAuth integration"
        status: "completed"
        priority: "P1"
        handoff: "HO-039-apple-oauth.yaml"
        depends_on: []
        description: "Apple Sign In with BaseOAuthProvider pattern"
        completed_at: "2026-01-16"
        skeleton_files:
          - "apps/backend/src/modules/auth/oauth/apple-oauth.provider.ts"

      - id: "TASK-040"
        title: "Backend: Account linking"
        status: "completed"
        priority: "P1"
        handoff: "HO-040-account-linking.yaml"
        depends_on: ["TASK-038"]
        description: "Link OAuth accounts to existing email accounts"
        completed_at: "2026-01-16"

      - id: "TASK-041"
        title: "Frontend: OAuth login buttons"
        status: "completed"
        priority: "P0"
        handoff: "HO-041-oauth-buttons.yaml"
        depends_on: ["TASK-038"]
        description: "Add Google/Apple sign-in buttons to login page"
        completed_at: "2026-01-16"
        skeleton_files:
          - "apps/user-web/src/components/auth/OAuthButtons.tsx"
          - "apps/user-web/src/components/auth/OAuthCallback.tsx"
          - "packages/api-client/src/api.ts"
          - "packages/api-client/src/hooks.ts"

  - id: "iter-012"
    goal: "E2E Testing Infrastructure"
    started_at: "2026-01-16"
    status: "implementing"
    tasks:
      - id: "TASK-042"
        title: "Testing: Playwright setup and configuration"
        status: "completed"
        priority: "P0"
        handoff: "HO-042-playwright-setup.yaml"
        depends_on: []
        description: "Install Playwright, configure browsers, create test utils"
        completed_at: "2026-01-16"
        skeleton_files:
          - "e2e/playwright.config.ts"
          - "e2e/global-setup.ts"
          - "e2e/global-teardown.ts"
          - "e2e/fixtures/test-fixtures.ts"
          - "e2e/package.json"
          - "e2e/tsconfig.json"

      - id: "TASK-043"
        title: "Testing: Auth flow E2E tests"
        status: "completed"
        priority: "P0"
        handoff: "HO-043-auth-e2e.yaml"
        depends_on: ["TASK-042"]
        description: "Test login, register, logout, password reset"
        completed_at: "2026-01-16"
        skeleton_files:
          - "e2e/tests/auth.setup.ts"
          - "e2e/tests/auth.spec.ts"

      - id: "TASK-044"
        title: "Testing: Check-in flow E2E tests"
        status: "completed"
        priority: "P0"
        handoff: "HO-044-checkin-e2e.yaml"
        depends_on: ["TASK-042"]
        description: "Test check-in, settings, history, contacts pages"
        completed_at: "2026-01-16"
        skeleton_files:
          - "e2e/tests/check-in.spec.ts"

      - id: "TASK-045"
        title: "Testing: GitHub Actions CI integration"
        status: "completed"
        priority: "P0"
        handoff: "HO-045-ci-integration.yaml"
        depends_on: ["TASK-043", "TASK-044"]
        description: "Run E2E tests on PR and main branch"
        completed_at: "2026-01-16"
        skeleton_files:
          - ".github/workflows/e2e.yml"

# ============================================================
# 5.1 Iteration History
# ============================================================
iteration_history:
  - id: "iter-009"
    goal: "Reminder notifications and contact verification"
    started_at: "2026-01-16"
    completed_at: "2026-01-16"
    status: "completed"
    summary: |
      Reminder notifications and contact verification complete:
      - Reminder cron job runs every minute
      - Sends reminder email before check-in deadline
      - Tracks lastReminderSentAt to prevent duplicates
      - Contact verification email on request
      - UUID token with 24-hour expiration
      - Public verification endpoint
      - Frontend verification page
    tasks_completed:
      - id: "TASK-029"
        title: "Backend: Reminder notification system"
        review_verdict: "pass"
      - id: "TASK-030"
        title: "Frontend: Reminder settings UI"
        review_verdict: "deferred"
        note: "Backend-only for iter-009"
      - id: "TASK-031"
        title: "Backend: Send verification emails"
        review_verdict: "pass"
      - id: "TASK-032"
        title: "Backend: Verification email templates"
        review_verdict: "pass"
      - id: "TASK-033"
        title: "Backend + Frontend: Verification endpoint and page"
        review_verdict: "pass"
    milestone: "Reminder Notifications & Contact Verification"

  - id: "iter-008"
    goal: "Notification system and missed check-in detection - core safety feature"
    started_at: "2026-01-16"
    completed_at: "2026-01-16"
    status: "completed"
    summary: |
      Core safety feature complete - notification system:
      - Alert and Notification database models with enums
      - Bull queue infrastructure with Redis
      - Email service with nodemailer (HTML + text templates)
      - Notification module with queue processor
      - Alert module with CRUD API endpoints
      - Missed check-in detector (runs every minute)
      - Timezone-aware deadline detection
      - Alert expiration job (daily cleanup)
    tasks_completed:
      - id: "TASK-023"
        title: "Database: Alert and Notification models"
        review_verdict: "pass"
      - id: "TASK-024"
        title: "Backend: Bull queue infrastructure"
        review_verdict: "pass"
      - id: "TASK-025"
        title: "Backend: Email service"
        review_verdict: "pass"
      - id: "TASK-026"
        title: "Backend: Notification module"
        review_verdict: "pass"
      - id: "TASK-027"
        title: "Backend: Alert module"
        review_verdict: "pass"
      - id: "TASK-028"
        title: "Backend: Missed check-in detector"
        review_verdict: "pass"
    milestone: "Core Safety Feature Complete"

  - id: "iter-007"
    goal: "User preferences system and error handling infrastructure"
    started_at: "2026-01-15"
    completed_at: "2026-01-16"
    status: "completed"
    summary: |
      User preferences and error handling complete:
      - Shared error codes in @solo-guardian/types
      - Backend BusinessException + GlobalExceptionFilter
      - Frontend useErrorHandler hook + ErrorBoundary
      - Error i18n messages (English, Chinese, Japanese)
      - UserPreferences database model with feature toggles
      - Backend preferences CRUD endpoints
      - Frontend onboarding flow and settings page
      - Theme system with CSS variables
    tasks_completed:
      - id: "TASK-017"
        title: "Shared: Error codes and types"
        review_verdict: "pass"
      - id: "TASK-018"
        title: "Backend: Error handling infrastructure"
        review_verdict: "pass"
      - id: "TASK-019"
        title: "Frontend: Error handling hooks and i18n"
        review_verdict: "pass"
      - id: "TASK-020"
        title: "Database: UserPreferences model"
        review_verdict: "pass"
      - id: "TASK-021"
        title: "Backend: User preferences module"
        review_verdict: "pass"
      - id: "TASK-022"
        title: "Frontend: Preferences and onboarding"
        review_verdict: "pass"
    milestone: "User Preferences & Error Handling Complete"

  - id: "iter-006"
    goal: "Implement emergency contacts module - core safety feature"
    started_at: "2026-01-15"
    completed_at: "2026-01-15"
    status: "completed"
    summary: |
      Emergency contacts module complete:
      - EmergencyContact database model with soft delete
      - Backend CRUD API with 6 endpoints
      - Frontend contacts page with add/edit/delete
      - i18n support (English, Chinese, Japanese)
      - Max 5 contacts per user with priority ordering
    tasks_completed:
      - id: "TASK-014"
        title: "Database: Add EmergencyContact model"
        review_verdict: "pass"
      - id: "TASK-015"
        title: "Backend: Emergency contacts module"
        review_verdict: "pass"
      - id: "TASK-016"
        title: "Frontend: Emergency contacts page"
        review_verdict: "pass"
    milestone: "Emergency Contacts Complete"

  - id: "iter-005"
    goal: "Implement user-web frontend MVP"
    started_at: "2026-01-15"
    completed_at: "2026-01-15"
    status: "completed"
    summary: |
      User-web frontend MVP complete:
      - Vite + React + TypeScript + Tailwind + shadcn/ui setup
      - Shared API client package (@solo-guardian/api-client)
      - Auth pages (Login/Register) with Zustand state
      - Main pages (Dashboard/Settings/History)
      - Mobile responsive design
      - Internationalization (English, Chinese, Japanese)
    tasks_completed:
      - id: "TASK-008"
        title: "Frontend: User-web infrastructure setup"
        review_verdict: "pass"
      - id: "TASK-009"
        title: "Frontend: Shared API client package"
        review_verdict: "pass"
      - id: "TASK-010"
        title: "Frontend: Auth pages (Login/Register)"
        review_verdict: "pass"
      - id: "TASK-011"
        title: "Frontend: Main pages (Dashboard/Settings/History)"
        review_verdict: "pass"
      - id: "TASK-012"
        title: "Frontend: Fix return types and cleanup"
        review_verdict: "pass"
        resolves: ["ISS-012", "ISS-013"]
      - id: "TASK-013"
        title: "Frontend: Internationalization (i18n) setup"
        review_verdict: "pass"
    issues_resolved:
      - "ISS-012: Missing JSX.Element return types"
      - "ISS-013: Leftover TODO(B) marker"
    milestone: "User Web MVP Complete"

  - id: "iter-004"
    goal: "Add JWT Auth Guard to protect API endpoints"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      JWT authentication guard complete:
      - JwtStrategy with Passport JWT
      - JwtAuthGuard for protecting routes
      - CurrentUser decorator for extracting userId
      - Check-in endpoints now protected
      - Settings moved to separate controller
    tasks_completed:
      - id: "TASK-007"
        title: "Backend: Create JwtAuthGuard and CurrentUser decorator"
        review_verdict: "pass"
    milestone: "Backend MVP Complete"

  - id: "iter-003"
    goal: "Implement check-in module MVP - core safety check-in functionality"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      Check-in module MVP complete:
      - Daily check-in with one-tap confirmation
      - Check-in settings (deadline, reminder time, timezone)
      - Check-in history with pagination
      - Today status with overdue detection
    tasks_completed:
      - id: "TASK-005"
        title: "Database: Add CheckIn and CheckInSettings models"
        review_verdict: "pass"
      - id: "TASK-006"
        title: "Backend: Check-in module implementation"
        review_verdict: "pass"
    deferred_items:
      - "Auth guard integration (hardcoded userId) → iter-004 TASK-007"

  - id: "iter-002"
    goal: "Auth module hardening - security logging and config validation"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      Auth module hardening complete:
      - Security event logging for login/register/refresh
      - JWT secret validation on startup (fail-fast)
      - All deferred issues from iter-001 resolved
    tasks_completed:
      - id: "TASK-003"
        title: "Backend: Add security event logging"
        review_verdict: "pass"
        resolves: "ISS-001"
      - id: "TASK-004"
        title: "Backend: Add JWT secret validation"
        review_verdict: "pass"
        resolves: "ISS-002"
    issues_resolved:
      - "ISS-001: Security event logging"
      - "ISS-002: JWT secret validation"

  - id: "iter-001"
    goal: "Complete user authentication MVP"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      Successfully implemented auth module MVP:
      - Email/password registration and login
      - JWT access/refresh token management
      - Refresh token rotation
      - Password hashing with bcrypt (cost 12)
    tasks_completed:
      - id: "TASK-000"
        title: "Backend: Project infrastructure setup"
        review_verdict: "pass"
      - id: "TASK-001"
        title: "Backend: Auth module - Fill TODOs"
        review_verdict: "conditional_pass"
      - id: "TASK-002"
        title: "Backend: Auth module - Remove leftover TODO"
        review_verdict: "pass"
    deferred_issues:
      - "ISS-001: Security event logging → iter-002 TASK-003"
      - "ISS-002: JWT secret validation → iter-002 TASK-004"

# ============================================================
# 6. Pending Decisions
# ============================================================
pending_decisions:
  - id: "PD-001"
    topic: "File upload storage solution"
    options:
      - "Local storage + Nginx proxy"
      - "AWS S3"
      - "Cloudflare R2"
    deadline: "iter-002"

# ============================================================
# 7. Architecture Decision Records (ADR Log)
# ============================================================
decision_log:
  - id: "ADR-001"
    date: "2026-01-14"
    decision: "Use Monorepo structure"
    rationale: "Easier type sharing, better AI context understanding"

  - id: "ADR-002"
    date: "2026-01-14"
    decision: "Backend uses NestJS"
    rationale: "Modular design, native TypeScript support, easy type sharing with frontend"

  - id: "ADR-003"
    date: "2026-01-14"
    decision: "Use feature branches for iterations"
    rationale: "Keep main branch stable, feature/iter-XXX for development"

  - id: "ADR-004"
    date: "2026-01-14"
    decision: "Check-in uses date-based uniqueness (one per day)"
    rationale: |
      - User can only check in once per day (no duplicate check-ins)
      - Check-in date stored as DATE type (not timestamp) for easy querying
      - Allows "re-check-in" by updating existing record
      - Simplifies "did user check in today?" queries

  - id: "ADR-005"
    date: "2026-01-14"
    decision: "Check-in settings default to 10:00 deadline if not set"
    rationale: |
      - New users should have sensible defaults
      - 10:00 AM is a reasonable morning deadline
      - User can customize after registration

  - id: "ADR-006"
    date: "2026-01-14"
    decision: "Use NestJS Passport JWT strategy for authentication"
    rationale: |
      - Standard pattern for NestJS JWT authentication
      - JwtAuthGuard for protecting routes
      - CurrentUser decorator for extracting user from token
      - Consistent with NestJS ecosystem

  - id: "ADR-007"
    date: "2026-01-15"
    decision: "User-web uses Vite + React + shadcn/ui + Tailwind"
    rationale: |
      - Vite for fast development and build
      - shadcn/ui for accessible, customizable components
      - Tailwind for mobile-first responsive design
      - TanStack Query for server state management
      - Zustand for client state (auth tokens)

  - id: "ADR-008"
    date: "2026-01-15"
    decision: "Shared API client package (@solo-guardian/api-client)"
    rationale: |
      - Type-safe API calls matching backend
      - Automatic token refresh handling
      - Shared between user-web and admin-web
      - TanStack Query hooks for data fetching

  - id: "ADR-009"
    date: "2026-01-15"
    decision: "Use react-i18next for internationalization"
    rationale: |
      - Most popular i18n solution for React
      - Excellent TypeScript support
      - Namespace-based organization (auth, dashboard, settings, history)
      - Built-in language detection and persistence
      - Interpolation support for dynamic values
    languages:
      - "en: English (default)"
      - "zh: Chinese Simplified"
      - "ja: Japanese"

  - id: "ADR-010"
    date: "2026-01-15"
    decision: "Emergency contacts with priority ordering and 5-contact limit"
    rationale: |
      - Each user can have up to 5 emergency contacts
      - Contacts have priority order (1-5) for notification sequence
      - Contact types: email (MVP), phone/SMS (future)
      - Contacts must be verified before activation (future)
      - Soft delete to preserve notification history
    schema:
      fields:
        - "id: UUID primary key"
        - "userId: FK to User"
        - "name: Contact's name"
        - "email: Contact's email address"
        - "phone: Optional phone number (future)"
        - "priority: 1-5 ordering"
        - "isVerified: Boolean (default false)"
        - "isActive: Boolean (default true)"
        - "createdAt, updatedAt, deletedAt"

  - id: "ADR-011"
    date: "2026-01-15"
    decision: "Feature toggle system with preferFeaturesOn flag"
    rationale: |
      - No user labeling (no "elder"/"young" mode)
      - Users choose features they want
      - preferFeaturesOn: auto-enable new features on upgrade or not
      - Core features as DB columns (queryable)
      - Optional features in JSON field (flexible, no schema changes)
    schema:
      fields:
        - "id: UUID primary key"
        - "userId: FK to User (unique)"
        - "preferFeaturesOn: Boolean (default false)"
        - "fontSize: Int (14-24, default 16)"
        - "highContrast: Boolean (default false)"
        - "reducedMotion: Boolean (default false)"
        - "hobbyCheckIn: Boolean (default false)"
        - "familyAccess: Boolean (default false)"
        - "optionalFeatures: JSON (flexible storage)"
        - "onboardingCompleted: Boolean (default false)"
        - "createdAt, updatedAt"

  - id: "ADR-012"
    date: "2026-01-15"
    decision: "Standardized error handling with i18n support"
    rationale: |
      - Error codes shared between backend and frontend (packages/types)
      - Error categories: VALIDATION, AUTH, BUSINESS, NOT_FOUND, CONFLICT, RATE_LIMIT, SYSTEM
      - Backend: BusinessException + GlobalExceptionFilter
      - Frontend: useErrorHandler hook + i18n error messages
      - User errors get friendly messages, system errors get apologetic messages
      - Error response includes i18nKey for frontend translation
    error_response_format:
      success: false
      error:
        code: "AUTH_1001"
        category: "AUTH"
        message: "English default message"
        i18nKey: "error.auth.invalidCredentials"
        details: {}
        field: "email"
        timestamp: "2026-01-15T10:00:00Z"

  - id: "ADR-013"
    date: "2026-01-16"
    decision: "Notification system with Bull queue and Redis"
    rationale: |
      - Bull queue for reliable job processing with retries
      - Redis for queue storage (already available)
      - Separate notification from detection (async decoupling)
      - Track notification status (pending, sent, delivered, failed)
      - Email via nodemailer with SMTP (flexible provider)
    architecture:
      flow: |
        1. Cron job runs every minute
        2. Detects users past deadline without check-in today
        3. Creates Alert record (triggered status)
        4. Queues notification jobs for each emergency contact
        5. Worker processes jobs, sends emails
        6. Updates notification status
      retry_policy: "3 retries with exponential backoff"
      job_timeout: "30 seconds"
    schema:
      alert:
        - "id: UUID primary key"
        - "userId: FK to User"
        - "status: triggered | notified | resolved | expired"
        - "triggeredAt: When deadline passed"
        - "resolvedAt: When user checked in (late)"
        - "createdAt, updatedAt"
      notification:
        - "id: UUID primary key"
        - "alertId: FK to Alert"
        - "contactId: FK to EmergencyContact"
        - "channel: email | sms (future)"
        - "status: pending | sent | delivered | failed"
        - "sentAt: When notification sent"
        - "error: Error message if failed"
        - "createdAt, updatedAt"

  - id: "ADR-014"
    date: "2026-01-16"
    decision: "Missed check-in detection with timezone awareness"
    rationale: |
      - Users have different timezones and deadlines
      - Cron runs every minute, checks all users
      - Convert user deadline to UTC for comparison
      - Only trigger alert once per day per user
      - Alert status prevents duplicate notifications
    detection_logic: |
      For each user with settings:
        1. Get user's deadline time (e.g., "10:00") and timezone
        2. Convert to today's UTC timestamp
        3. If NOW() > deadline AND no check-in today AND no active alert today:
           - Create Alert
           - Queue notifications
    considerations:
      - "Must handle timezone edge cases (DST transitions)"
      - "Must not create duplicate alerts for same day"
      - "Must not notify already-notified contacts"

  - id: "ADR-015"
    date: "2026-01-16"
    decision: "Reminder notifications before check-in deadline"
    rationale: |
      - Users set reminderTime and reminderEnabled in CheckInSettings
      - Send friendly reminder email to user (not to emergency contacts)
      - Reminds user to check in before deadline to avoid alerting contacts
      - Must track last reminder sent to prevent duplicate reminders
    implementation:
      schema_changes:
        - "Add lastReminderSentAt (DateTime?) to CheckInSettings"
      detection_logic: |
        1. Cron job runs every minute
        2. Find users where:
           - reminderEnabled = true
           - Current time in user's timezone matches reminderTime (within 1 min)
           - User hasn't checked in today
           - lastReminderSentAt is not today
        3. Send reminder email to user's email
        4. Update lastReminderSentAt to now
      email_template:
        subject: "[Solo Guardian] Reminder: Time to check in"
        content: "Friendly reminder to check in before your deadline"

  - id: "ADR-016"
    date: "2026-01-16"
    decision: "Emergency contact email verification"
    rationale: |
      - Verify contacts before they receive emergency alerts
      - Prevent spam/abuse by ensuring contact owns the email
      - Build trust with contacts before critical notifications
      - isVerified field already exists in EmergencyContact (default false)
    implementation:
      schema_changes:
        - "Add verificationToken (String?) to EmergencyContact"
        - "Add verificationTokenExpiresAt (DateTime?) to EmergencyContact"
      flow: |
        1. User adds emergency contact
        2. System generates verification token (UUID)
        3. Send verification email with link: /verify-contact?token=xxx
        4. Contact clicks link
        5. Backend validates token and marks isVerified = true
        6. Token is cleared after use
      considerations:
        - "Token expires after 24 hours"
        - "User can resend verification email"
        - "Unverified contacts can still be added but won't receive alerts"
        - "Public endpoint (no auth required for verification)"

  - id: "ADR-017"
    date: "2026-01-16"
    decision: "Phone number verification via SMS OTP"
    rationale: |
      - Verify phone numbers before sending SMS alerts
      - Use 6-digit OTP (One-Time Password) sent via SMS
      - OTP is simpler and more mobile-friendly than email links
      - Ensures contact has access to the phone number
      - Required before contact can receive SMS notifications
    implementation:
      schema_changes:
        - "Add phoneVerified (Boolean, default false) to EmergencyContact"
        - "Add phoneOtp (String?) to EmergencyContact"
        - "Add phoneOtpExpiresAt (DateTime?) to EmergencyContact"
        - "Add preferredChannel (NotificationChannel) to EmergencyContact"
      flow: |
        1. User requests phone verification for contact
        2. System generates 6-digit OTP using crypto.randomInt
        3. Store OTP and expiry (10 minutes) in database
        4. Send OTP via SmsService.sendVerificationSms()
        5. User enters OTP received on contact's phone
        6. Backend validates OTP using crypto.timingSafeEqual (timing attack prevention)
        7. Mark phoneVerified = true, clear OTP fields
      api_endpoints:
        - "POST /api/v1/emergency-contacts/:id/send-phone-verification"
        - "POST /api/v1/emergency-contacts/:id/verify-phone"
        - "POST /api/v1/emergency-contacts/:id/resend-phone-verification"
      security:
        - "OTP expires after 10 minutes"
        - "Use crypto.timingSafeEqual for constant-time comparison"
        - "Use crypto.randomInt for cryptographic OTP generation"
        - "Phone numbers masked in logs (show only last 4 digits)"
        - "Rate limiting recommended (max 3 OTPs per 10 minutes)"

  - id: "ADR-018"
    date: "2026-01-16"
    decision: "Contact notification channel preference"
    rationale: |
      - Contacts can choose to receive notifications via email or SMS
      - preferredChannel field on EmergencyContact (default 'email')
      - SMS channel requires verified phone number
      - Allows flexibility while maintaining verification requirements
    implementation:
      field: "preferredChannel: NotificationChannel"
      default: "email"
      validation:
        - "SMS requires: contact.phone exists AND contact.phoneVerified = true"
        - "If SMS selected but not valid, fall back to email"
      ui:
        - "RadioGroup in contact form (Email / SMS)"
        - "SMS option disabled if no phone number"
        - "Warning if SMS selected but phone not verified"

# ============================================================
# 8. Review History (Recorded by A Session)
# ============================================================
review_history:
  - iteration: "iter-007"
    task: "TASK-022"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-16"
    issues_found: []
    notes: "Onboarding flow, settings page, theme system complete"

  - iteration: "iter-007"
    task: "TASK-021"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-16"
    issues_found: []
    notes: "User preferences backend module with 4 endpoints"

  - iteration: "iter-007"
    task: "TASK-020"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-16"
    issues_found: []
    notes: "UserPreferences Prisma model with feature toggles"

  - iteration: "iter-007"
    task: "TASK-019"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-16"
    issues_found: []
    notes: "Frontend error handling with useErrorHandler and ErrorBoundary"

  - iteration: "iter-007"
    task: "TASK-018"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-16"
    issues_found: []
    notes: "Backend BusinessException and GlobalExceptionFilter"

  - iteration: "iter-007"
    task: "TASK-017"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-16"
    issues_found: []
    notes: "Shared error codes in @solo-guardian/types"

  - iteration: "iter-006"
    task: "TASK-016"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "Emergency contacts frontend page with i18n support"

  - iteration: "iter-006"
    task: "TASK-015"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "Backend CRUD module with 6 endpoints, soft delete, priority ordering"

  - iteration: "iter-006"
    task: "TASK-014"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "EmergencyContact model with soft delete and priority ordering"

  - iteration: "iter-005"
    task: "TASK-012"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    resolves: ["ISS-012", "ISS-013"]
    notes: "Fixed return types and removed leftover TODO markers"

  - iteration: "iter-005"
    task: "TASK-013"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "Excellent i18n implementation with 3 languages (en/zh/ja)"

  - iteration: "iter-005"
    task: "TASK-010"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "Clean implementation with good patterns"

  - iteration: "iter-005"
    task: "TASK-011"
    reviewer: "C Session"
    verdict: "conditional_pass"
    date: "2026-01-15"
    issues_found:
      - id: "ISS-012"
        type: "constraint_violation"
        severity: "error"
        description: "Missing JSX.Element return types on 10 React components"
        resolution: "Resolved in TASK-012"
      - id: "ISS-013"
        type: "todo_incomplete"
        severity: "warning"
        description: "Leftover TODO(B) marker in Header.tsx"
        resolution: "Resolved in TASK-012"
      - id: "ISS-014"
        type: "consistency"
        severity: "suggestion"
        description: "Missing file headers with @task annotation"
        resolution: "Optional improvement"
    notes: "Functionally complete, constraint fixes resolved in TASK-012"

  - iteration: "iter-003"
    task: "TASK-005"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []

  - iteration: "iter-004"
    task: "TASK-007"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []
    notes: "Settings controller separated per ISS-008 suggestion"

  - iteration: "iter-003"
    task: "TASK-006"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found:
      - id: "ISS-008"
        type: "consistency"
        severity: "suggestion"
        description: "Consider separate controller for settings"
        resolution: "Resolved in iter-004 TASK-007"

  - iteration: "iter-002"
    task: "TASK-003"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []
    resolves: "ISS-001"

  - iteration: "iter-002"
    task: "TASK-004"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []
    resolves: "ISS-002"

  - iteration: "iter-001"
    task: "TASK-000"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found:
      - id: "ISS-006"
        type: "consistency"
        severity: "suggestion"
        description: "Consider using NestJS Logger instead of console.log"
        resolution: "Resolved in iter-002 TASK-003"
      - id: "ISS-007"
        type: "consistency"
        severity: "suggestion"
        description: "Consider adding global API prefix"
        resolution: "Optional improvement"

  - iteration: "iter-001"
    task: "TASK-001"
    reviewer: "C Session"
    verdict: "conditional_pass"
    date: "2026-01-14"
    issues_found:
      - id: "ISS-001"
        type: "security"
        severity: "warning"
        description: "Missing security event logging"
        resolution: "Resolved in iter-002 TASK-003"
      - id: "ISS-002"
        type: "error_handling"
        severity: "warning"
        description: "JWT secrets not validated on startup"
        resolution: "Resolved in iter-002 TASK-004"
      - id: "ISS-003"
        type: "consistency"
        severity: "warning"
        description: "Multi-step operations not in transaction"
        resolution: "Acceptable for MVP"
      - id: "ISS-004"
        type: "todo_incomplete"
        severity: "suggestion"
        description: "Leftover TODO in register.dto.ts"
        resolution: "Resolved in iter-001 TASK-002"

# ============================================================
# 9. Bugfix History (Post-Review Fixes)
# ============================================================
bugfix_history:
  - id: "BUGFIX-001"
    iteration: "iter-006"
    date: "2026-01-15"
    source: "PR code review"
    status: "completed"
    bugs_fixed:
      - id: "BUG-001"
        title: "Route shadowing in emergency-contacts controller"
        severity: "P0"
        description: "@Put(':id') shadowed @Put('reorder'), making reorder endpoint inaccessible"
        fix: "Moved @Put('reorder') before @Put(':id')"
        file: "emergency-contacts.controller.ts"

      - id: "BUG-002"
        title: "Soft delete unique constraint conflict"
        severity: "P0"
        description: "Standard unique constraints on userId+email and userId+priority don't exclude soft-deleted records"
        fix: "Created partial unique indexes with WHERE deleted_at IS NULL"
        files:
          - "schema.prisma"
          - "migrations/20260115140000_fix_emergency_contact_unique_constraints/migration.sql"

      - id: "BUG-003"
        title: "Auto-priority conflict with sparse priorities"
        severity: "P1"
        description: "Using count+1 for auto-priority fails when priorities are sparse (e.g., [1,2,4,5])"
        fix: "Changed to use max(priority)+1"
        files:
          - "emergency-contacts.repository.ts"
          - "emergency-contacts.service.ts"

      - id: "BUG-004"
        title: "Reorder unique constraint violation"
        severity: "P1"
        description: "Sequential UPDATEs during priority swap cause constraint violations"
        fix: "Use atomic UPDATE with CASE expression for all priorities at once"
        file: "emergency-contacts.repository.ts"

      - id: "BUG-005"
        title: "Auto-priority exceeds valid range"
        severity: "P1"
        description: "max+1 can produce priority > 5 when priorities are sparse"
        fix: "Find lowest available slot in 1-5 range instead"
        file: "emergency-contacts.service.ts"

# ============================================================
# 10. E2E Test Recommendations
# ============================================================
e2e_test_recommendations:
  module: "emergency_contacts"
  priority: "P1"
  rationale: "Multiple edge cases discovered during review that should be regression-tested"

  test_cases:
    - id: "E2E-EC-001"
      scenario: "Create contact after soft delete"
      description: "User can create contact with same email after soft-deleting previous one"
      steps:
        - "Create contact with email A"
        - "Delete contact"
        - "Create new contact with email A"
        - "Verify success (no unique constraint error)"

    - id: "E2E-EC-002"
      scenario: "Reorder contacts with swap"
      description: "Swapping priorities of two contacts works atomically"
      steps:
        - "Create contacts with priorities 1, 2, 3"
        - "Reorder: swap priority 1 and 3"
        - "Verify priorities updated correctly"

    - id: "E2E-EC-003"
      scenario: "Auto-priority after deletion"
      description: "New contact gets correct priority after deleting middle contact"
      steps:
        - "Create contacts with priorities 1, 2, 3"
        - "Delete contact with priority 2"
        - "Create new contact (no explicit priority)"
        - "Verify new contact gets priority 2 (lowest available)"

    - id: "E2E-EC-004"
      scenario: "Max contacts limit"
      description: "Cannot exceed 5 contacts per user"
      steps:
        - "Create 5 contacts"
        - "Attempt to create 6th contact"
        - "Verify appropriate error returned"

    - id: "E2E-EC-005"
      scenario: "Reorder endpoint accessible"
      description: "PUT /emergency-contacts/reorder is not shadowed by :id route"
      steps:
        - "Create contacts with priorities 1, 2"
        - "Call PUT /emergency-contacts/reorder"
        - "Verify 200 response (not 404 or validation error)"

  suggested_iteration: "iter-008 or dedicated testing iteration"
  tools: "Jest + Supertest for backend API E2E"
