# ============================================================
# DESIGN_STATE - Single Source of Truth
# ============================================================
# Rules:
#   - Only A Session (Opus) can modify this file
#   - Must update version and updated_at on every change
#   - B/C Sessions can only read, not modify
#   - All design decisions must be recorded here
# ============================================================

meta:
  version: "0.8.0"
  updated_at: "2026-01-14"
  updated_by: "A Session"
  branch: "main"
  project_name: "Solo Guardian"
  description: "Safety check-in app for people living alone"

# ============================================================
# 1. Technical Architecture
# ============================================================
architecture:
  pattern: "Layered Architecture + Modular"
  
  backend:
    language: "TypeScript"
    framework: "NestJS"
    database: "PostgreSQL"
    cache: "Redis"
    orm: "Prisma"
    
  frontend_shared:
    language: "TypeScript"
    ui_framework: "React 18"
    state_management: "Zustand"
    styling: "Tailwind CSS"
    api_client: "TanStack Query + Axios"
    
  admin_web:
    base: "frontend_shared"
    routing: "React Router"
    ui_library: "Ant Design"
    
  user_web:
    base: "frontend_shared"
    routing: "React Router"
    ui_library: "shadcn/ui"
    responsive: true
    breakpoints:
      mobile: "< 768px"
      tablet: "768px - 1024px"
      desktop: "> 1024px"
    
  mobile:
    android:
      language: "Kotlin"
      ui: "Jetpack Compose"
      architecture: "MVVM + Clean Architecture"
      di: "Hilt"
      networking: "Retrofit + OkHttp"
    ios:
      status: "planned"
      language: "Swift"
      ui: "SwiftUI"

# ============================================================
# 2. Business Modules
# ============================================================
modules:
  auth:
    status: "done"  # designing | in_progress | done | blocked
    owner: "B Session"
    description: "User authentication and authorization"
    skeleton_created: true
    skeleton_version: "0.2.0"
    completed_iteration: "iter-002"
    hardened: true
    features:
      - name: "Email/Password Login"
        priority: "P0"
        status: "done"
      - name: "JWT Token Management"
        priority: "P0"
        status: "done"
      - name: "Security Event Logging"
        priority: "P0"
        status: "done"
        added_in: "iter-002"
      - name: "Config Validation"
        priority: "P0"
        status: "done"
        added_in: "iter-002"
      - name: "OAuth (Google/Apple)"
        priority: "P1"
        status: "pending"
      - name: "Role-Based Access Control (RBAC)"
        priority: "P0"
        status: "pending"
    
  user:
    status: "pending"
    owner: null
    description: "User management"
    features:
      - name: "User CRUD"
        priority: "P0"
        status: "pending"
      - name: "Profile editing"
        priority: "P1"
        status: "pending"

  check_in:
    status: "in_progress"  # designing | in_progress | done | blocked
    owner: "B Session"
    description: "Core check-in functionality - daily safety check-in"
    skeleton_created: true
    skeleton_version: "0.8.0"
    features:
      - name: "Daily Check-in"
        priority: "P0"
        status: "in_progress"
        description: "User can check in with one tap to confirm safety"
      - name: "Check-in Settings"
        priority: "P0"
        status: "in_progress"
        description: "User can set daily deadline and reminder time"
      - name: "Check-in History"
        priority: "P0"
        status: "in_progress"
        description: "View past check-in records"
      - name: "Today Status"
        priority: "P0"
        status: "in_progress"
        description: "Check if user has checked in today"
      - name: "Missed Check-in Detection"
        priority: "P1"
        status: "pending"
        description: "Scheduled job to detect missed check-ins (future)"
      - name: "Check-in Streak"
        priority: "P2"
        status: "pending"
        description: "Track consecutive check-in days (gamification)"

# ============================================================
# 3. API Design Constraints
# ============================================================
api_constraints:
  style: "RESTful"
  versioning: "URL prefix (/api/v1)"
  
  naming:
    - "Use plural for resource names: /users, /posts"
    - "Use kebab-case: /user-profiles"
    - "Max 2 levels of nesting: /users/{id}/posts"
    
  response_format:
    success: |
      {
        "success": true,
        "data": { ... },
        "meta": { "page": 1, "total": 100 }
      }
    error: |
      {
        "success": false,
        "error": {
          "code": "AUTH_001",
          "message": "Token expired",
          "details": { ... }
        }
      }
      
  authentication:
    method: "Bearer Token (JWT)"
    header: "Authorization: Bearer <token>"
    refresh_strategy: "Refresh Token Rotation"

# ============================================================
# 4. Code Constraints (For B/C Session validation)
# ============================================================
code_constraints:
  general:
    - "No `any` type allowed (TypeScript)"
    - "All functions must have return type declaration"
    - "Single file < 300 lines"
    - "Single function < 50 lines"
    
  backend:
    - "Controller only does parameter validation and calls Service"
    - "Service contains business logic, does not directly access database"
    - "Repository handles database operations"
    - "All database operations must be in transactions"
    - "Sensitive operations must be logged"
    
  frontend:
    - "Use functional components + Hooks"
    - "Extract business logic to custom hooks"
    - "Separate UI components from business components"
    - "All API calls through api-client package"
    
  mobile:
    - "Separate UI from business logic (Compose + ViewModel)"
    - "Use StateFlow/SharedFlow for state management"
    - "Network requests through Repository layer"

# ============================================================
# 5. Current Iteration
# ============================================================
current_iteration:
  id: "iter-003"
  goal: "Implement check-in module MVP - core safety check-in functionality"
  started_at: "2026-01-14"

  tasks:
    - id: "TASK-005"
      title: "Database: Add CheckIn and CheckInSettings models"
      assigned_to: "B Session"
      status: "pending"
      priority: "P0"
      handoff_doc: ".claude/handoffs/iter-003/HO-005-checkin-schema.yaml"
      acceptance_criteria:
        - "CheckIn model added to schema.prisma"
        - "CheckInSettings model added to schema.prisma"
        - "Proper relations to User model"
        - "prisma generate succeeds"
        - "prisma migrate dev succeeds"
      files:
        - "apps/backend/prisma/schema.prisma"

    - id: "TASK-006"
      title: "Backend: Check-in module skeleton with TODOs"
      assigned_to: "B Session"
      status: "pending"
      priority: "P0"
      depends_on: "TASK-005"
      handoff_doc: ".claude/handoffs/iter-003/HO-006-checkin-module.yaml"
      acceptance_criteria:
        - "POST /api/v1/check-ins creates a check-in"
        - "GET /api/v1/check-ins returns user's check-in history"
        - "GET /api/v1/check-ins/today returns today's status"
        - "GET /api/v1/check-in-settings returns user's settings"
        - "PUT /api/v1/check-in-settings updates settings"
        - "All endpoints require authentication"
        - "Follows Controller/Service/Repository pattern"
      files:
        - "apps/backend/src/modules/check-in/check-in.module.ts"
        - "apps/backend/src/modules/check-in/check-in.controller.ts"
        - "apps/backend/src/modules/check-in/check-in.service.ts"
        - "apps/backend/src/modules/check-in/check-in.repository.ts"
        - "apps/backend/src/modules/check-in/dto/create-check-in.dto.ts"
        - "apps/backend/src/modules/check-in/dto/check-in-settings.dto.ts"
        - "apps/backend/src/modules/check-in/dto/check-in-response.dto.ts"

  blocked_tasks: []
  completed_tasks: []

# ============================================================
# 5.1 Iteration History
# ============================================================
iteration_history:
  - id: "iter-002"
    goal: "Auth module hardening - security logging and config validation"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      Auth module hardening complete:
      - Security event logging for login/register/refresh
      - JWT secret validation on startup (fail-fast)
      - All deferred issues from iter-001 resolved
    tasks_completed:
      - id: "TASK-003"
        title: "Backend: Add security event logging"
        review_verdict: "pass"
        resolves: "ISS-001"
      - id: "TASK-004"
        title: "Backend: Add JWT secret validation"
        review_verdict: "pass"
        resolves: "ISS-002"
    issues_resolved:
      - "ISS-001: Security event logging"
      - "ISS-002: JWT secret validation"

  - id: "iter-001"
    goal: "Complete user authentication MVP"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      Successfully implemented auth module MVP:
      - Email/password registration and login
      - JWT access/refresh token management
      - Refresh token rotation
      - Password hashing with bcrypt (cost 12)
    tasks_completed:
      - id: "TASK-000"
        title: "Backend: Project infrastructure setup"
        review_verdict: "pass"
      - id: "TASK-001"
        title: "Backend: Auth module - Fill TODOs"
        review_verdict: "conditional_pass"
      - id: "TASK-002"
        title: "Backend: Auth module - Remove leftover TODO"
        review_verdict: "pass"
    deferred_issues:
      - "ISS-001: Security event logging → iter-002 TASK-003"
      - "ISS-002: JWT secret validation → iter-002 TASK-004"

# ============================================================
# 6. Pending Decisions
# ============================================================
pending_decisions:
  - id: "PD-001"
    topic: "File upload storage solution"
    options:
      - "Local storage + Nginx proxy"
      - "AWS S3"
      - "Cloudflare R2"
    deadline: "iter-002"

# ============================================================
# 7. Architecture Decision Records (ADR Log)
# ============================================================
decision_log:
  - id: "ADR-001"
    date: "2026-01-14"
    decision: "Use Monorepo structure"
    rationale: "Easier type sharing, better AI context understanding"

  - id: "ADR-002"
    date: "2026-01-14"
    decision: "Backend uses NestJS"
    rationale: "Modular design, native TypeScript support, easy type sharing with frontend"

  - id: "ADR-003"
    date: "2026-01-14"
    decision: "Use feature branches for iterations"
    rationale: "Keep main branch stable, feature/iter-XXX for development"

  - id: "ADR-004"
    date: "2026-01-14"
    decision: "Check-in uses date-based uniqueness (one per day)"
    rationale: |
      - User can only check in once per day (no duplicate check-ins)
      - Check-in date stored as DATE type (not timestamp) for easy querying
      - Allows "re-check-in" by updating existing record
      - Simplifies "did user check in today?" queries

  - id: "ADR-005"
    date: "2026-01-14"
    decision: "Check-in settings default to 10:00 deadline if not set"
    rationale: |
      - New users should have sensible defaults
      - 10:00 AM is a reasonable morning deadline
      - User can customize after registration

# ============================================================
# 8. Review History (Recorded by A Session)
# ============================================================
review_history:
  - iteration: "iter-002"
    task: "TASK-003"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []
    resolves: "ISS-001"

  - iteration: "iter-002"
    task: "TASK-004"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []
    resolves: "ISS-002"

  - iteration: "iter-001"
    task: "TASK-000"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found:
      - id: "ISS-006"
        type: "consistency"
        severity: "suggestion"
        description: "Consider using NestJS Logger instead of console.log"
        resolution: "Resolved in iter-002 TASK-003"
      - id: "ISS-007"
        type: "consistency"
        severity: "suggestion"
        description: "Consider adding global API prefix"
        resolution: "Optional improvement"

  - iteration: "iter-001"
    task: "TASK-001"
    reviewer: "C Session"
    verdict: "conditional_pass"
    date: "2026-01-14"
    issues_found:
      - id: "ISS-001"
        type: "security"
        severity: "warning"
        description: "Missing security event logging"
        resolution: "Resolved in iter-002 TASK-003"
      - id: "ISS-002"
        type: "error_handling"
        severity: "warning"
        description: "JWT secrets not validated on startup"
        resolution: "Resolved in iter-002 TASK-004"
      - id: "ISS-003"
        type: "consistency"
        severity: "warning"
        description: "Multi-step operations not in transaction"
        resolution: "Acceptable for MVP"
      - id: "ISS-004"
        type: "todo_incomplete"
        severity: "suggestion"
        description: "Leftover TODO in register.dto.ts"
        resolution: "Resolved in iter-001 TASK-002"
