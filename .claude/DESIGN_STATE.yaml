# ============================================================
# DESIGN_STATE - Single Source of Truth
# ============================================================
# Rules:
#   - Only A Session (Opus) can modify this file
#   - Must update version and updated_at on every change
#   - B/C Sessions can only read, not modify
#   - All design decisions must be recorded here
# ============================================================

meta:
  version: "1.5.0"
  updated_at: "2026-01-15"
  updated_by: "A Session"
  branch: "feature/iter-006-emergency-contacts"
  project_name: "Solo Guardian"
  description: "Safety check-in app for people living alone"
  milestone: "Emergency Contacts Complete"

# ============================================================
# 1. Technical Architecture
# ============================================================
architecture:
  pattern: "Layered Architecture + Modular"
  
  backend:
    language: "TypeScript"
    framework: "NestJS"
    database: "PostgreSQL"
    cache: "Redis"
    orm: "Prisma"
    
  frontend_shared:
    language: "TypeScript"
    ui_framework: "React 18"
    state_management: "Zustand"
    styling: "Tailwind CSS"
    api_client: "TanStack Query + Axios"
    
  admin_web:
    base: "frontend_shared"
    routing: "React Router"
    ui_library: "Ant Design"
    
  user_web:
    base: "frontend_shared"
    routing: "React Router"
    ui_library: "shadcn/ui"
    i18n: "react-i18next"
    languages: ["en", "zh", "ja"]
    responsive: true
    breakpoints:
      mobile: "< 768px"
      tablet: "768px - 1024px"
      desktop: "> 1024px"
    
  mobile:
    android:
      language: "Kotlin"
      ui: "Jetpack Compose"
      architecture: "MVVM + Clean Architecture"
      di: "Hilt"
      networking: "Retrofit + OkHttp"
    ios:
      status: "planned"
      language: "Swift"
      ui: "SwiftUI"

# ============================================================
# 2. Business Modules
# ============================================================
modules:
  auth:
    status: "done"  # designing | in_progress | done | blocked
    owner: "B Session"
    description: "User authentication and authorization"
    skeleton_created: true
    skeleton_version: "0.2.0"
    completed_iteration: "iter-004"
    hardened: true
    features:
      - name: "Email/Password Login"
        priority: "P0"
        status: "done"
      - name: "JWT Token Management"
        priority: "P0"
        status: "done"
      - name: "Security Event Logging"
        priority: "P0"
        status: "done"
        added_in: "iter-002"
      - name: "Config Validation"
        priority: "P0"
        status: "done"
        added_in: "iter-002"
      - name: "JWT Auth Guard"
        priority: "P0"
        status: "done"
        added_in: "iter-004"
        description: "Protect endpoints with JWT authentication"
      - name: "OAuth (Google/Apple)"
        priority: "P1"
        status: "pending"
      - name: "Role-Based Access Control (RBAC)"
        priority: "P0"
        status: "pending"
    
  user:
    status: "pending"
    owner: null
    description: "User management"
    features:
      - name: "User CRUD"
        priority: "P0"
        status: "pending"
      - name: "Profile editing"
        priority: "P1"
        status: "pending"

  check_in:
    status: "done"  # designing | in_progress | done | blocked
    owner: "B Session"
    description: "Core check-in functionality - daily safety check-in"
    skeleton_created: true
    skeleton_version: "0.8.0"
    completed_iteration: "iter-003"
    features:
      - name: "Daily Check-in"
        priority: "P0"
        status: "done"
        description: "User can check in with one tap to confirm safety"
      - name: "Check-in Settings"
        priority: "P0"
        status: "done"
        description: "User can set daily deadline and reminder time"
      - name: "Check-in History"
        priority: "P0"
        status: "done"
        description: "View past check-in records"
      - name: "Today Status"
        priority: "P0"
        status: "done"
        description: "Check if user has checked in today"
      - name: "Overdue Detection"
        priority: "P0"
        status: "done"
        description: "Check if user is past deadline without check-in"
      - name: "Missed Check-in Detection"
        priority: "P1"
        status: "pending"
        description: "Scheduled job to detect missed check-ins (future)"
      - name: "Check-in Streak"
        priority: "P2"
        status: "pending"
        description: "Track consecutive check-in days (gamification)"

  emergency_contacts:
    status: "done"
    owner: "B Session"
    description: "Emergency contacts management - people to notify if user misses check-in"
    started_iteration: "iter-006"
    completed_iteration: "iter-006"
    skeleton_created: true
    skeleton_version: "0.1.0"
    features:
      - name: "Contact CRUD"
        priority: "P0"
        status: "done"
        description: "Add, edit, delete emergency contacts"
        completed_task: "TASK-015"
      - name: "Contact List"
        priority: "P0"
        status: "done"
        description: "View all emergency contacts"
        completed_task: "TASK-015"
      - name: "Contact Verification"
        priority: "P1"
        status: "pending"
        description: "Verify contact email/phone before activation"
      - name: "Contact Limit"
        priority: "P0"
        status: "done"
        description: "Maximum 5 emergency contacts per user"
        completed_task: "TASK-015"

  user_web:
    status: "done"
    owner: "B Session"
    description: "User-facing web application"
    started_iteration: "iter-005"
    completed_iteration: "iter-006"
    features:
      - name: "Login/Register"
        priority: "P0"
        status: "done"
        completed_task: "TASK-010"
      - name: "Check-in Dashboard"
        priority: "P0"
        status: "done"
        completed_task: "TASK-011"
      - name: "Check-in Settings"
        priority: "P0"
        status: "done"
        completed_task: "TASK-011"
      - name: "Check-in History"
        priority: "P0"
        status: "done"
        completed_task: "TASK-011"
      - name: "Mobile Responsive"
        priority: "P0"
        status: "done"
        completed_task: "TASK-011"
      - name: "Internationalization (i18n)"
        priority: "P0"
        status: "done"
        description: "Support for English, Chinese, Japanese"
        completed_task: "TASK-013"
      - name: "Emergency Contacts Page"
        priority: "P0"
        status: "done"
        description: "Manage emergency contacts in user-web"
        completed_task: "TASK-016"

# ============================================================
# 3. API Design Constraints
# ============================================================
api_constraints:
  style: "RESTful"
  versioning: "URL prefix (/api/v1)"
  
  naming:
    - "Use plural for resource names: /users, /posts"
    - "Use kebab-case: /user-profiles"
    - "Max 2 levels of nesting: /users/{id}/posts"
    
  response_format:
    success: |
      {
        "success": true,
        "data": { ... },
        "meta": { "page": 1, "total": 100 }
      }
    error: |
      {
        "success": false,
        "error": {
          "code": "AUTH_001",
          "message": "Token expired",
          "details": { ... }
        }
      }
      
  authentication:
    method: "Bearer Token (JWT)"
    header: "Authorization: Bearer <token>"
    refresh_strategy: "Refresh Token Rotation"

# ============================================================
# 4. Code Constraints (For B/C Session validation)
# ============================================================
code_constraints:
  general:
    - "No `any` type allowed (TypeScript)"
    - "All functions must have return type declaration"
    - "Single file < 300 lines"
    - "Single function < 50 lines"
    
  backend:
    - "Controller only does parameter validation and calls Service"
    - "Service contains business logic, does not directly access database"
    - "Repository handles database operations"
    - "All database operations must be in transactions"
    - "Sensitive operations must be logged"
    
  frontend:
    - "Use functional components + Hooks"
    - "Extract business logic to custom hooks"
    - "Separate UI components from business components"
    - "All API calls through api-client package"
    
  mobile:
    - "Separate UI from business logic (Compose + ViewModel)"
    - "Use StateFlow/SharedFlow for state management"
    - "Network requests through Repository layer"

# ============================================================
# 5. Current Iteration
# ============================================================
current_iteration:
  id: "iter-006"
  goal: "Implement emergency contacts module - core safety feature"
  started_at: "2026-01-15"
  completed_at: "2026-01-15"
  status: "completed"
  tasks:
    - id: "TASK-014"
      title: "Database: Add EmergencyContact model"
      status: "completed"
      priority: "P0"
      handoff: "HO-014-emergency-contact-db.yaml"
      depends_on: []
      description: "Prisma schema for emergency contacts"
      review_verdict: "pass"

    - id: "TASK-015"
      title: "Backend: Emergency contacts module"
      status: "completed"
      priority: "P0"
      handoff: "HO-015-emergency-contacts-backend.yaml"
      depends_on: ["TASK-014"]
      description: "NestJS module with CRUD operations for emergency contacts"
      review_verdict: "pass"

    - id: "TASK-016"
      title: "Frontend: Emergency contacts page"
      status: "completed"
      priority: "P0"
      handoff: "HO-016-emergency-contacts-frontend.yaml"
      depends_on: ["TASK-015"]
      description: "User-web page for managing emergency contacts"
      review_verdict: "pass"

# ============================================================
# 5.1 Iteration History
# ============================================================
iteration_history:
  - id: "iter-006"
    goal: "Implement emergency contacts module - core safety feature"
    started_at: "2026-01-15"
    completed_at: "2026-01-15"
    status: "completed"
    summary: |
      Emergency contacts module complete:
      - EmergencyContact database model with soft delete
      - Backend CRUD API with 6 endpoints
      - Frontend contacts page with add/edit/delete
      - i18n support (English, Chinese, Japanese)
      - Max 5 contacts per user with priority ordering
    tasks_completed:
      - id: "TASK-014"
        title: "Database: Add EmergencyContact model"
        review_verdict: "pass"
      - id: "TASK-015"
        title: "Backend: Emergency contacts module"
        review_verdict: "pass"
      - id: "TASK-016"
        title: "Frontend: Emergency contacts page"
        review_verdict: "pass"
    milestone: "Emergency Contacts Complete"

  - id: "iter-005"
    goal: "Implement user-web frontend MVP"
    started_at: "2026-01-15"
    completed_at: "2026-01-15"
    status: "completed"
    summary: |
      User-web frontend MVP complete:
      - Vite + React + TypeScript + Tailwind + shadcn/ui setup
      - Shared API client package (@solo-guardian/api-client)
      - Auth pages (Login/Register) with Zustand state
      - Main pages (Dashboard/Settings/History)
      - Mobile responsive design
      - Internationalization (English, Chinese, Japanese)
    tasks_completed:
      - id: "TASK-008"
        title: "Frontend: User-web infrastructure setup"
        review_verdict: "pass"
      - id: "TASK-009"
        title: "Frontend: Shared API client package"
        review_verdict: "pass"
      - id: "TASK-010"
        title: "Frontend: Auth pages (Login/Register)"
        review_verdict: "pass"
      - id: "TASK-011"
        title: "Frontend: Main pages (Dashboard/Settings/History)"
        review_verdict: "pass"
      - id: "TASK-012"
        title: "Frontend: Fix return types and cleanup"
        review_verdict: "pass"
        resolves: ["ISS-012", "ISS-013"]
      - id: "TASK-013"
        title: "Frontend: Internationalization (i18n) setup"
        review_verdict: "pass"
    issues_resolved:
      - "ISS-012: Missing JSX.Element return types"
      - "ISS-013: Leftover TODO(B) marker"
    milestone: "User Web MVP Complete"

  - id: "iter-004"
    goal: "Add JWT Auth Guard to protect API endpoints"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      JWT authentication guard complete:
      - JwtStrategy with Passport JWT
      - JwtAuthGuard for protecting routes
      - CurrentUser decorator for extracting userId
      - Check-in endpoints now protected
      - Settings moved to separate controller
    tasks_completed:
      - id: "TASK-007"
        title: "Backend: Create JwtAuthGuard and CurrentUser decorator"
        review_verdict: "pass"
    milestone: "Backend MVP Complete"

  - id: "iter-003"
    goal: "Implement check-in module MVP - core safety check-in functionality"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      Check-in module MVP complete:
      - Daily check-in with one-tap confirmation
      - Check-in settings (deadline, reminder time, timezone)
      - Check-in history with pagination
      - Today status with overdue detection
    tasks_completed:
      - id: "TASK-005"
        title: "Database: Add CheckIn and CheckInSettings models"
        review_verdict: "pass"
      - id: "TASK-006"
        title: "Backend: Check-in module implementation"
        review_verdict: "pass"
    deferred_items:
      - "Auth guard integration (hardcoded userId) → iter-004 TASK-007"

  - id: "iter-002"
    goal: "Auth module hardening - security logging and config validation"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      Auth module hardening complete:
      - Security event logging for login/register/refresh
      - JWT secret validation on startup (fail-fast)
      - All deferred issues from iter-001 resolved
    tasks_completed:
      - id: "TASK-003"
        title: "Backend: Add security event logging"
        review_verdict: "pass"
        resolves: "ISS-001"
      - id: "TASK-004"
        title: "Backend: Add JWT secret validation"
        review_verdict: "pass"
        resolves: "ISS-002"
    issues_resolved:
      - "ISS-001: Security event logging"
      - "ISS-002: JWT secret validation"

  - id: "iter-001"
    goal: "Complete user authentication MVP"
    started_at: "2026-01-14"
    completed_at: "2026-01-14"
    status: "completed"
    summary: |
      Successfully implemented auth module MVP:
      - Email/password registration and login
      - JWT access/refresh token management
      - Refresh token rotation
      - Password hashing with bcrypt (cost 12)
    tasks_completed:
      - id: "TASK-000"
        title: "Backend: Project infrastructure setup"
        review_verdict: "pass"
      - id: "TASK-001"
        title: "Backend: Auth module - Fill TODOs"
        review_verdict: "conditional_pass"
      - id: "TASK-002"
        title: "Backend: Auth module - Remove leftover TODO"
        review_verdict: "pass"
    deferred_issues:
      - "ISS-001: Security event logging → iter-002 TASK-003"
      - "ISS-002: JWT secret validation → iter-002 TASK-004"

# ============================================================
# 6. Pending Decisions
# ============================================================
pending_decisions:
  - id: "PD-001"
    topic: "File upload storage solution"
    options:
      - "Local storage + Nginx proxy"
      - "AWS S3"
      - "Cloudflare R2"
    deadline: "iter-002"

# ============================================================
# 7. Architecture Decision Records (ADR Log)
# ============================================================
decision_log:
  - id: "ADR-001"
    date: "2026-01-14"
    decision: "Use Monorepo structure"
    rationale: "Easier type sharing, better AI context understanding"

  - id: "ADR-002"
    date: "2026-01-14"
    decision: "Backend uses NestJS"
    rationale: "Modular design, native TypeScript support, easy type sharing with frontend"

  - id: "ADR-003"
    date: "2026-01-14"
    decision: "Use feature branches for iterations"
    rationale: "Keep main branch stable, feature/iter-XXX for development"

  - id: "ADR-004"
    date: "2026-01-14"
    decision: "Check-in uses date-based uniqueness (one per day)"
    rationale: |
      - User can only check in once per day (no duplicate check-ins)
      - Check-in date stored as DATE type (not timestamp) for easy querying
      - Allows "re-check-in" by updating existing record
      - Simplifies "did user check in today?" queries

  - id: "ADR-005"
    date: "2026-01-14"
    decision: "Check-in settings default to 10:00 deadline if not set"
    rationale: |
      - New users should have sensible defaults
      - 10:00 AM is a reasonable morning deadline
      - User can customize after registration

  - id: "ADR-006"
    date: "2026-01-14"
    decision: "Use NestJS Passport JWT strategy for authentication"
    rationale: |
      - Standard pattern for NestJS JWT authentication
      - JwtAuthGuard for protecting routes
      - CurrentUser decorator for extracting user from token
      - Consistent with NestJS ecosystem

  - id: "ADR-007"
    date: "2026-01-15"
    decision: "User-web uses Vite + React + shadcn/ui + Tailwind"
    rationale: |
      - Vite for fast development and build
      - shadcn/ui for accessible, customizable components
      - Tailwind for mobile-first responsive design
      - TanStack Query for server state management
      - Zustand for client state (auth tokens)

  - id: "ADR-008"
    date: "2026-01-15"
    decision: "Shared API client package (@solo-guardian/api-client)"
    rationale: |
      - Type-safe API calls matching backend
      - Automatic token refresh handling
      - Shared between user-web and admin-web
      - TanStack Query hooks for data fetching

  - id: "ADR-009"
    date: "2026-01-15"
    decision: "Use react-i18next for internationalization"
    rationale: |
      - Most popular i18n solution for React
      - Excellent TypeScript support
      - Namespace-based organization (auth, dashboard, settings, history)
      - Built-in language detection and persistence
      - Interpolation support for dynamic values
    languages:
      - "en: English (default)"
      - "zh: Chinese Simplified"
      - "ja: Japanese"

  - id: "ADR-010"
    date: "2026-01-15"
    decision: "Emergency contacts with priority ordering and 5-contact limit"
    rationale: |
      - Each user can have up to 5 emergency contacts
      - Contacts have priority order (1-5) for notification sequence
      - Contact types: email (MVP), phone/SMS (future)
      - Contacts must be verified before activation (future)
      - Soft delete to preserve notification history
    schema:
      fields:
        - "id: UUID primary key"
        - "userId: FK to User"
        - "name: Contact's name"
        - "email: Contact's email address"
        - "phone: Optional phone number (future)"
        - "priority: 1-5 ordering"
        - "isVerified: Boolean (default false)"
        - "isActive: Boolean (default true)"
        - "createdAt, updatedAt, deletedAt"

# ============================================================
# 8. Review History (Recorded by A Session)
# ============================================================
review_history:
  - iteration: "iter-006"
    task: "TASK-016"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "Emergency contacts frontend page with i18n support"

  - iteration: "iter-006"
    task: "TASK-015"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "Backend CRUD module with 6 endpoints, soft delete, priority ordering"

  - iteration: "iter-006"
    task: "TASK-014"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "EmergencyContact model with soft delete and priority ordering"

  - iteration: "iter-005"
    task: "TASK-012"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    resolves: ["ISS-012", "ISS-013"]
    notes: "Fixed return types and removed leftover TODO markers"

  - iteration: "iter-005"
    task: "TASK-013"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "Excellent i18n implementation with 3 languages (en/zh/ja)"

  - iteration: "iter-005"
    task: "TASK-010"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-15"
    issues_found: []
    notes: "Clean implementation with good patterns"

  - iteration: "iter-005"
    task: "TASK-011"
    reviewer: "C Session"
    verdict: "conditional_pass"
    date: "2026-01-15"
    issues_found:
      - id: "ISS-012"
        type: "constraint_violation"
        severity: "error"
        description: "Missing JSX.Element return types on 10 React components"
        resolution: "Resolved in TASK-012"
      - id: "ISS-013"
        type: "todo_incomplete"
        severity: "warning"
        description: "Leftover TODO(B) marker in Header.tsx"
        resolution: "Resolved in TASK-012"
      - id: "ISS-014"
        type: "consistency"
        severity: "suggestion"
        description: "Missing file headers with @task annotation"
        resolution: "Optional improvement"
    notes: "Functionally complete, constraint fixes resolved in TASK-012"

  - iteration: "iter-003"
    task: "TASK-005"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []

  - iteration: "iter-004"
    task: "TASK-007"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []
    notes: "Settings controller separated per ISS-008 suggestion"

  - iteration: "iter-003"
    task: "TASK-006"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found:
      - id: "ISS-008"
        type: "consistency"
        severity: "suggestion"
        description: "Consider separate controller for settings"
        resolution: "Resolved in iter-004 TASK-007"

  - iteration: "iter-002"
    task: "TASK-003"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []
    resolves: "ISS-001"

  - iteration: "iter-002"
    task: "TASK-004"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found: []
    resolves: "ISS-002"

  - iteration: "iter-001"
    task: "TASK-000"
    reviewer: "C Session"
    verdict: "pass"
    date: "2026-01-14"
    issues_found:
      - id: "ISS-006"
        type: "consistency"
        severity: "suggestion"
        description: "Consider using NestJS Logger instead of console.log"
        resolution: "Resolved in iter-002 TASK-003"
      - id: "ISS-007"
        type: "consistency"
        severity: "suggestion"
        description: "Consider adding global API prefix"
        resolution: "Optional improvement"

  - iteration: "iter-001"
    task: "TASK-001"
    reviewer: "C Session"
    verdict: "conditional_pass"
    date: "2026-01-14"
    issues_found:
      - id: "ISS-001"
        type: "security"
        severity: "warning"
        description: "Missing security event logging"
        resolution: "Resolved in iter-002 TASK-003"
      - id: "ISS-002"
        type: "error_handling"
        severity: "warning"
        description: "JWT secrets not validated on startup"
        resolution: "Resolved in iter-002 TASK-004"
      - id: "ISS-003"
        type: "consistency"
        severity: "warning"
        description: "Multi-step operations not in transaction"
        resolution: "Acceptable for MVP"
      - id: "ISS-004"
        type: "todo_incomplete"
        severity: "suggestion"
        description: "Leftover TODO in register.dto.ts"
        resolution: "Resolved in iter-001 TASK-002"
