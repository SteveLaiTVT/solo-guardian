# ============================================================
# HANDOFF: HO-009 - Shared API Client Package
# ============================================================
# From: A Session (Architect)
# To: B Session (Implementer)
# Created: 2026-01-15
# ============================================================

handoff_id: "HO-009"
design_state_version: "1.1.0"
priority: "P0"

# ============================================================
# Objective
# ============================================================
objective: |
  Create shared API client package using Axios and TanStack Query
  that can be used by both user-web and admin-web applications.

# ============================================================
# Context
# ============================================================
context: |
  The API client package provides:
  - Type-safe API calls matching backend endpoints
  - Automatic token management (access/refresh)
  - TanStack Query hooks for data fetching
  - Shared between user-web and admin-web

# ============================================================
# Tasks
# ============================================================
tasks:
  - id: "TASK-009-1"
    title: "Initialize package"
    action: |
      ```bash
      mkdir -p packages/api-client/src
      cd packages/api-client
      npm init -y
      ```

  - id: "TASK-009-2"
    title: "Configure package.json"
    file: "packages/api-client/package.json"
    action: |
      ```json
      {
        "name": "@solo-guardian/api-client",
        "version": "0.1.0",
        "main": "src/index.ts",
        "types": "src/index.ts",
        "scripts": {
          "typecheck": "tsc --noEmit"
        },
        "dependencies": {
          "axios": "^1.6.0",
          "@tanstack/react-query": "^5.0.0"
        },
        "peerDependencies": {
          "react": "^18.0.0"
        }
      }
      ```

  - id: "TASK-009-3"
    title: "Create TypeScript types"
    file: "packages/api-client/src/types.ts"
    action: |
      Define types matching backend API:

      ```typescript
      // API Response wrapper
      export interface ApiResponse<T> {
        success: boolean;
        data: T;
        meta?: { page?: number; total?: number; pageSize?: number };
      }

      export interface ApiError {
        success: false;
        error: {
          code: string;
          message: string;
          details?: Record<string, unknown>;
        };
      }

      // Auth types
      export interface AuthResult {
        accessToken: string;
        refreshToken: string;
        expiresIn: number;
      }

      export interface LoginRequest {
        email: string;
        password: string;
      }

      export interface RegisterRequest {
        email: string;
        password: string;
        name: string;
      }

      // Check-in types
      export interface CheckIn {
        id: string;
        checkInDate: string;
        checkedInAt: string;
        note?: string;
      }

      export interface CreateCheckInRequest {
        note?: string;
      }

      export interface TodayStatus {
        hasCheckedIn: boolean;
        checkIn?: CheckIn;
        isOverdue: boolean;
        deadline: string;
        currentTime: string;
      }

      export interface CheckInSettings {
        deadlineTime: string;
        reminderTime: string;
        reminderEnabled: boolean;
        timezone: string;
      }

      export interface UpdateSettingsRequest {
        deadlineTime?: string;
        reminderTime?: string;
        reminderEnabled?: boolean;
        timezone?: string;
      }
      ```

  - id: "TASK-009-4"
    title: "Create Axios instance with interceptors"
    file: "packages/api-client/src/client.ts"
    action: |
      Create axios instance with:
      - Base URL from config
      - Request interceptor to add Authorization header
      - Response interceptor for 401 handling (token refresh)

      ```typescript
      import axios from 'axios';

      export interface ApiClientConfig {
        baseUrl: string;
        getAccessToken: () => string | null;
        getRefreshToken: () => string | null;
        onTokenRefresh: (tokens: { accessToken: string; refreshToken: string }) => void;
        onAuthError: () => void;
      }

      export function createApiClient(config: ApiClientConfig) {
        const client = axios.create({
          baseURL: config.baseUrl,
          headers: { 'Content-Type': 'application/json' },
        });

        // Request interceptor - add token
        client.interceptors.request.use((req) => {
          const token = config.getAccessToken();
          if (token) {
            req.headers.Authorization = `Bearer ${token}`;
          }
          return req;
        });

        // Response interceptor - handle 401
        client.interceptors.response.use(
          (res) => res,
          async (error) => {
            // TODO(B): Implement token refresh on 401
            // 1. Check if 401 and not refresh endpoint
            // 2. Try to refresh token
            // 3. Retry original request
            // 4. If refresh fails, call onAuthError
            throw error;
          }
        );

        return client;
      }
      ```

  - id: "TASK-009-5"
    title: "Create API service functions"
    file: "packages/api-client/src/api.ts"
    action: |
      Create typed API functions:

      ```typescript
      import { AxiosInstance } from 'axios';
      import * as T from './types';

      export function createApi(client: AxiosInstance) {
        return {
          auth: {
            login: (data: T.LoginRequest) =>
              client.post<T.ApiResponse<T.AuthResult>>('/api/v1/auth/login', data),

            register: (data: T.RegisterRequest) =>
              client.post<T.ApiResponse<T.AuthResult>>('/api/v1/auth/register', data),

            refresh: (refreshToken: string) =>
              client.post<T.ApiResponse<T.AuthResult>>('/api/v1/auth/refresh', { refreshToken }),

            logout: (refreshToken: string) =>
              client.post('/api/v1/auth/logout', { refreshToken }),
          },

          checkIn: {
            create: (data?: T.CreateCheckInRequest) =>
              client.post<T.ApiResponse<T.CheckIn>>('/api/v1/check-ins', data || {}),

            getToday: () =>
              client.get<T.ApiResponse<T.TodayStatus>>('/api/v1/check-ins/today'),

            getHistory: (page = 1, pageSize = 30) =>
              client.get<T.ApiResponse<{ records: T.CheckIn[] }>>('/api/v1/check-ins', {
                params: { page, pageSize },
              }),
          },

          settings: {
            get: () =>
              client.get<T.ApiResponse<T.CheckInSettings>>('/api/v1/check-in-settings'),

            update: (data: T.UpdateSettingsRequest) =>
              client.put<T.ApiResponse<T.CheckInSettings>>('/api/v1/check-in-settings', data),
          },
        };
      }
      ```

  - id: "TASK-009-6"
    title: "Create TanStack Query hooks"
    file: "packages/api-client/src/hooks.ts"
    action: |
      Create React Query hooks:

      ```typescript
      import { useMutation, useQuery, useQueryClient } from '@tanstack/react-query';
      import { createApi } from './api';
      import { AxiosInstance } from 'axios';

      export function createHooks(client: AxiosInstance) {
        const api = createApi(client);

        return {
          // Check-in hooks
          useCheckInToday: () =>
            useQuery({
              queryKey: ['checkIn', 'today'],
              queryFn: () => api.checkIn.getToday().then((r) => r.data.data),
            }),

          useCheckInHistory: (page: number, pageSize: number) =>
            useQuery({
              queryKey: ['checkIn', 'history', page, pageSize],
              queryFn: () => api.checkIn.getHistory(page, pageSize).then((r) => r.data),
            }),

          useCreateCheckIn: () => {
            const queryClient = useQueryClient();
            return useMutation({
              mutationFn: (note?: string) => api.checkIn.create({ note }),
              onSuccess: () => {
                queryClient.invalidateQueries({ queryKey: ['checkIn'] });
              },
            });
          },

          // Settings hooks
          useSettings: () =>
            useQuery({
              queryKey: ['settings'],
              queryFn: () => api.settings.get().then((r) => r.data.data),
            }),

          useUpdateSettings: () => {
            const queryClient = useQueryClient();
            return useMutation({
              mutationFn: api.settings.update,
              onSuccess: () => {
                queryClient.invalidateQueries({ queryKey: ['settings'] });
              },
            });
          },

          // Auth hooks
          useLogin: () =>
            useMutation({
              mutationFn: api.auth.login,
            }),

          useRegister: () =>
            useMutation({
              mutationFn: api.auth.register,
            }),
        };
      }
      ```

  - id: "TASK-009-7"
    title: "Create package exports"
    file: "packages/api-client/src/index.ts"
    action: |
      ```typescript
      export * from './types';
      export * from './client';
      export * from './api';
      export * from './hooks';
      ```

  - id: "TASK-009-8"
    title: "Add tsconfig.json"
    file: "packages/api-client/tsconfig.json"
    action: |
      ```json
      {
        "compilerOptions": {
          "target": "ES2020",
          "module": "ESNext",
          "moduleResolution": "bundler",
          "strict": true,
          "esModuleInterop": true,
          "skipLibCheck": true,
          "declaration": true,
          "jsx": "react-jsx"
        },
        "include": ["src"]
      }
      ```

# ============================================================
# Deliverables
# ============================================================
deliverables:
  - "packages/api-client/package.json"
  - "packages/api-client/tsconfig.json"
  - "packages/api-client/src/types.ts - All API types"
  - "packages/api-client/src/client.ts - Axios instance"
  - "packages/api-client/src/api.ts - API functions"
  - "packages/api-client/src/hooks.ts - TanStack Query hooks"
  - "packages/api-client/src/index.ts - Exports"

# ============================================================
# Acceptance Criteria
# ============================================================
acceptance_criteria:
  - description: "TypeScript compiles"
    verification: "npm run typecheck passes"

  - description: "Types match backend API"
    verification: "Compare with backend DTOs"

  - description: "Can be imported by user-web"
    verification: "Import and use hooks in user-web"

# ============================================================
# Constraints
# ============================================================
constraints:
  - "No any types"
  - "All functions must have return types"
  - "Single file < 300 lines"
  - "Use TanStack Query v5"
  - "Axios ^1.6.0"

# ============================================================
# Notes
# ============================================================
notes: |
  The 401 interceptor for automatic token refresh has a TODO.
  B Session should implement the full token refresh logic.

  This package will be linked to user-web via workspace or
  relative path import.
