# ============================================================
# Handoff Document: GitHub Actions CI Integration
# @task TASK-045
# @design_state_version 3.0.0
# ============================================================

handoff_id: "HO-045"
task_id: "TASK-045"
title: "Testing: GitHub Actions CI integration"
design_state_version: "3.0.0"
created_at: "2026-01-16"
created_by: "A Session"

# ============================================================
# Objective
# ============================================================
objective: |
  Set up GitHub Actions workflow to run E2E tests on pull requests
  and main branch commits. Ensure tests pass before merging.

# ============================================================
# Prerequisites
# ============================================================
prerequisites:
  dependencies:
    - "TASK-042: Playwright setup"
    - "TASK-043: Auth E2E tests"
    - "TASK-044: Check-in E2E tests"

# ============================================================
# Files to Create
# ============================================================
files_to_create:
  - path: ".github/workflows/e2e-tests.yml"
    description: "E2E test workflow"

# ============================================================
# Workflow Configuration
# ============================================================
workflow_config:
  name: "E2E Tests"
  triggers:
    - "push to main"
    - "pull_request to main"

  jobs:
    e2e:
      runs_on: "ubuntu-latest"
      services:
        postgres:
          image: "postgres:15"
          env:
            POSTGRES_USER: "test"
            POSTGRES_PASSWORD: "test"
            POSTGRES_DB: "solo_guardian_test"
          ports:
            - "5432:5432"
        redis:
          image: "redis:7"
          ports:
            - "6379:6379"

      steps:
        - "Checkout code"
        - "Setup Node.js 20"
        - "Setup pnpm"
        - "Install dependencies"
        - "Install Playwright browsers"
        - "Setup database (prisma migrate)"
        - "Start backend in background"
        - "Run E2E tests"
        - "Upload test report on failure"

# ============================================================
# Workflow File
# ============================================================
workflow_yaml: |
  name: E2E Tests

  on:
    push:
      branches: [main]
    pull_request:
      branches: [main]

  jobs:
    e2e:
      runs-on: ubuntu-latest

      services:
        postgres:
          image: postgres:15
          env:
            POSTGRES_USER: test
            POSTGRES_PASSWORD: test
            POSTGRES_DB: solo_guardian_test
          ports:
            - 5432:5432
          options: >-
            --health-cmd pg_isready
            --health-interval 10s
            --health-timeout 5s
            --health-retries 5

        redis:
          image: redis:7
          ports:
            - 6379:6379

      steps:
        - uses: actions/checkout@v4

        - name: Setup Node.js
          uses: actions/setup-node@v4
          with:
            node-version: '20'

        - name: Setup pnpm
          uses: pnpm/action-setup@v2
          with:
            version: 8

        - name: Install dependencies
          run: pnpm install

        - name: Install Playwright browsers
          run: cd apps/user-web && npx playwright install --with-deps chromium

        - name: Setup database
          run: |
            cd apps/backend
            npx prisma migrate deploy
          env:
            DATABASE_URL: postgresql://test:test@localhost:5432/solo_guardian_test

        - name: Start backend
          run: |
            cd apps/backend
            pnpm run start:dev &
            sleep 10
          env:
            DATABASE_URL: postgresql://test:test@localhost:5432/solo_guardian_test
            REDIS_URL: redis://localhost:6379
            JWT_SECRET: test-secret-for-ci
            JWT_EXPIRES_IN: 1h

        - name: Run E2E tests
          run: cd apps/user-web && pnpm test:e2e
          env:
            CI: true

        - name: Upload test report
          uses: actions/upload-artifact@v4
          if: failure()
          with:
            name: playwright-report
            path: apps/user-web/playwright-report/
            retention-days: 7

# ============================================================
# Acceptance Criteria
# ============================================================
acceptance_criteria:
  - "Workflow runs on PR and push to main"
  - "PostgreSQL and Redis services available"
  - "Database migrated before tests"
  - "Backend starts successfully"
  - "E2E tests run and pass"
  - "Test report uploaded on failure"

# ============================================================
# Constraints
# ============================================================
constraints:
  - "Use GitHub-hosted runners"
  - "Tests should complete in < 10 minutes"
  - "Only run Chromium in CI (save time)"
  - "Cache node_modules and Playwright browsers"
