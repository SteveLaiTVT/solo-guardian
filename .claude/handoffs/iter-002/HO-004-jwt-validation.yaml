# ============================================================
# HANDOFF: HO-004 - JWT Secret Validation
# ============================================================
# From: A Session (Architect)
# To: B Session (Implementer)
# Created: 2026-01-14
# ============================================================

handoff_id: "HO-004"
design_state_version: "0.6.0"
priority: "P0"
source_issue: "ISS-002"

# ============================================================
# Objective
# ============================================================
objective: |
  Add startup validation for JWT secrets to fail fast if configuration
  is missing, rather than failing at runtime with unclear errors.

# ============================================================
# Context
# ============================================================
context: |
  From review RR-001-auth.yaml (ISS-002):
  "ConfigService.get<string>() returns undefined if env var is not set.
  If JWT_ACCESS_SECRET or JWT_REFRESH_SECRET is missing, the app
  will fail at runtime with an unclear error."

  Current code (auth.service.ts lines 175-176):
  ```typescript
  const accessSecret = this.configService.get<string>('JWT_ACCESS_SECRET');
  const refreshSecret = this.configService.get<string>('JWT_REFRESH_SECRET');
  ```

  Problem: If secrets are undefined, JWT signing will fail with a cryptic error.

# ============================================================
# Tasks
# ============================================================
tasks:
  - id: "TASK-004-1"
    title: "Add OnModuleInit interface"
    file: "apps/backend/src/modules/auth/auth.service.ts"
    action: |
      Implement OnModuleInit to validate secrets on startup:

      ```typescript
      import { Injectable, OnModuleInit } from '@nestjs/common';

      @Injectable()
      export class AuthService implements OnModuleInit {
        // ... existing constructor and properties

        onModuleInit(): void {
          this.validateJwtSecrets();
        }

        private validateJwtSecrets(): void {
          // TODO(B): Implement validation
        }
      }
      ```

  - id: "TASK-004-2"
    title: "Implement validateJwtSecrets"
    file: "apps/backend/src/modules/auth/auth.service.ts"
    action: |
      Validate that both JWT secrets are present and non-empty:

      ```typescript
      private validateJwtSecrets(): void {
        const accessSecret = this.configService.get<string>('JWT_ACCESS_SECRET');
        const refreshSecret = this.configService.get<string>('JWT_REFRESH_SECRET');

        if (!accessSecret) {
          throw new Error(
            'JWT_ACCESS_SECRET is not configured. ' +
            'Please set it in your environment variables.',
          );
        }

        if (!refreshSecret) {
          throw new Error(
            'JWT_REFRESH_SECRET is not configured. ' +
            'Please set it in your environment variables.',
          );
        }

        // Optionally log success
        this.logger.log('JWT secrets validated successfully');
      }
      ```

# ============================================================
# Acceptance Criteria
# ============================================================
acceptance_criteria:
  - description: "App fails fast if JWT_ACCESS_SECRET is missing"
    verification: "Remove JWT_ACCESS_SECRET from .env, app should not start"

  - description: "App fails fast if JWT_REFRESH_SECRET is missing"
    verification: "Remove JWT_REFRESH_SECRET from .env, app should not start"

  - description: "Clear error message for missing secrets"
    verification: "Error message mentions which secret is missing"

  - description: "Validation happens on module init"
    verification: "Error occurs before any request is handled"

# ============================================================
# Constraints
# ============================================================
constraints:
  - "Use OnModuleInit lifecycle hook"
  - "Throw Error (not custom exception) for startup failures"
  - "Error message must be clear and actionable"
  - "Keep function size under 50 lines"
  - "Do not log secret values"

# ============================================================
# Expected Error Output
# ============================================================
expected_errors: |
  When JWT_ACCESS_SECRET is missing:
  ```
  Error: JWT_ACCESS_SECRET is not configured. Please set it in your environment variables.
  ```

  When JWT_REFRESH_SECRET is missing:
  ```
  Error: JWT_REFRESH_SECRET is not configured. Please set it in your environment variables.
  ```

# ============================================================
# Out of Scope
# ============================================================
out_of_scope:
  - "Secret strength validation (min length, complexity)"
  - "Secret rotation mechanism"
  - "Environment-specific validation rules"

# ============================================================
# Notes
# ============================================================
notes: |
  This task depends on TASK-003 being done first (Logger added).
  The validateJwtSecrets() method should use this.logger for the
  success message.

  If TASK-003 is not complete, either:
  1. Wait for TASK-003
  2. Or add Logger as part of this task (minimal duplication)
